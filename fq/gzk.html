<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医保规则管理系统 v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        /* 加载动画 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader.active {
            display: flex;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 顶部导航 */
        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }

        .nav-menu {
            display: flex;
            gap: 5px;
        }

        .nav-item {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.3s;
            position: relative;
        }

        .nav-item:hover {
            background: #f7fafc;
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
            background: #edf2ff;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        /* 用户信息 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-btn {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .notification-btn:hover {
            background: #f7fafc;
        }

        .notification-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #f56565;
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
        }

        .user-avatar {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .user-avatar:hover {
            background: #f7fafc;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* 主容器 */
        .main-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 页面容器 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 面包屑导航 */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            color: #718096;
            font-size: 14px;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.3s;
        }

        .breadcrumb-item:hover {
            color: #667eea;
        }

        /* 仪表盘布局 */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
        }

        /* 侧边栏 */
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .folder-tree {
            margin-top: 10px;
        }

        .folder {
            margin-bottom: 2px;
        }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            user-select: none;
        }

        .folder-header:hover {
            background: #f7fafc;
        }

        .folder-header.active {
            background: #edf2ff;
            color: #667eea;
        }

        .folder-icon {
            width: 16px;
            transition: transform 0.3s;
        }

        .folder.expanded .folder-icon {
            transform: rotate(90deg);
        }

        .folder-children {
            margin-left: 24px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .folder.expanded .folder-children {
            max-height: 500px;
        }

        .folder-count {
            margin-left: auto;
            background: #e2e8f0;
            color: #4a5568;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* 工作区 */
        .workspace {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
        }

        .stat-change {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .stat-change.positive {
            background: #c6f6d5;
            color: #22543d;
        }

        .stat-change.negative {
            background: #fed7d7;
            color: #742a2a;
        }

        /* 工具栏 */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 搜索框 */
        .search-box {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        /* 筛选器 */
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:hover {
            border-color: #cbd5e0;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 按钮样式 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 6px;
        }

        /* 数据表格 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #2d3748;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .table-checkbox {
            width: 20px;
        }

        /* 状态标签 */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #feebc8;
            color: #744210;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-info {
            background: #bee3f8;
            color: #2a4e7c;
        }

        /* 分页 */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .pagination-info {
            color: #718096;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .page-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f7fafc;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }

        .form-label.required::after {
            content: ' *';
            color: #f56565;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .form-checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-help {
            margin-top: 4px;
            font-size: 13px;
            color: #718096;
        }

        .form-error {
            margin-top: 4px;
            font-size: 13px;
            color: #f56565;
        }

        /* 规则构建器样式 */
        .rule-builder-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .rule-main {
            background: white;
            border-radius: 8px;
            padding: 24px;
        }

        .rule-sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 80px;
        }

        .rule-section {
            margin-bottom: 32px;
            padding-bottom: 32px;
            border-bottom: 1px solid #e2e8f0;
        }

        .rule-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-subtitle {
            font-size: 13px;
            color: #718096;
            font-weight: normal;
        }

        /* 条件组 */
        .condition-group {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .condition-group.nested {
            background: #edf2ff;
            border-color: #667eea;
            margin-left: 20px;
        }

        .condition-row {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .condition-logic {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .logic-switch {
            display: inline-flex;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .logic-option {
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .logic-option.active {
            background: #667eea;
            color: white;
        }

        .remove-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: #fed7d7;
            color: #742a2a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background: #fc8181;
            color: white;
        }

        /* 新版规则构建器样式 */
        .builder-nav {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -24px -24px 24px -24px;
        }

        .builder-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #718096;
            font-size: 14px;
        }

        .builder-breadcrumb .separator {
            color: #cbd5e0;
        }

        .builder-actions {
            display: flex;
            gap: 8px;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #718096;
            font-size: 14px;
        }

        .progress-step.active {
            color: #667eea;
            font-weight: 500;
        }

        .progress-step.completed {
            color: #38a169;
        }

        .step-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
        }

        .progress-step.active .step-circle {
            background: #667eea;
            color: white;
        }

        .progress-step.completed .step-circle {
            background: #38a169;
            color: white;
        }

        /* 规则卡片样式 */
        .rule-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .rule-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #fafbfc;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .card-subtitle {
            color: #718096;
            font-size: 14px;
            margin-top: 4px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-content {
            padding: 24px;
        }

        /* 基本信息表单样式 */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .field-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .field-help {
            color: #718096;
            font-size: 13px;
            margin-top: 4px;
        }

        .rule-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .rule-type-option {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .rule-type-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .rule-type-option.selected {
            border-color: #667eea;
            background: #edf2ff;
        }

        .rule-type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .rule-type-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .rule-type-desc {
            font-size: 12px;
            color: #718096;
        }

        .scope-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .scope-option {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scope-option:hover {
            border-color: #667eea;
        }

        .scope-option.selected {
            border-color: #667eea;
            background: #edf2ff;
        }

        .scope-title {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .scope-desc {
            font-size: 12px;
            color: #718096;
        }

        .tag-input-container {
            position: relative;
        }

        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .tag-suggestion {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag-suggestion:hover {
            background: #edf2ff;
            border-color: #667eea;
        }

        /* 表单输入样式 */
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            text-decoration: none;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-primary:hover {
            background: #5a67d8;
            border-color: #5a67d8;
        }

        .btn-secondary {
            background: #718096;
            color: white;
            border-color: #718096;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border-color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: #718096;
            border-color: transparent;
        }

        .btn-ghost:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* 条件组样式 */
        .condition-group-wrapper {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .condition-group-header {
            background: #f7fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-logic {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-actions {
            display: flex;
            gap: 8px;
        }

        .condition-list {
            padding: 16px;
        }

        .condition-item {
            display: grid;
            grid-template-columns: 2fr 1fr 2fr auto;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border: 1px solid #f1f5f9;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
        }

        .condition-item:hover {
            border-color: #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .condition-footer {
            padding: 12px 16px;
            border-top: 1px solid #e2e8f0;
            background: #fafbfc;
        }

        /* 动作样式 */
        .action-list {
            margin-bottom: 16px;
        }

        .action-row {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr auto;
            gap: 12px;
            align-items: end;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            background: white;
        }

        .action-row:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .action-type,
        .action-params,
        .action-priority {
            display: flex;
            flex-direction: column;
        }

        .action-actions {
            display: flex;
            align-items: center;
        }

        .action-footer {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: #fafbfc;
        }

        /* 决策表样式 */
        .decision-table-wrapper {
            overflow-x: auto;
        }

        .table-container {
            min-width: 800px;
        }

        .decision-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            background: #f7fafc;
        }

        .condition-header,
        .action-header,
        .operation-header {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            text-align: left;
            vertical-align: top;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .header-title {
            font-weight: 500;
            color: #2d3748;
        }

        .header-actions {
            display: flex;
            gap: 4px;
        }

        .header-type {
            font-size: 11px;
            color: #718096;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .decision-row {
            border-bottom: 1px solid #e2e8f0;
        }

        .condition-cell,
        .action-cell,
        .operation-cell {
            padding: 8px 12px;
            border-right: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .condition-cell .form-select,
        .condition-cell .form-input,
        .action-cell .form-select,
        .action-cell .form-input {
            margin: 0;
            width: 100%;
        }

        .row-actions {
            display: flex;
            gap: 4px;
        }

        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }

        .table-stats {
            display: flex;
            gap: 16px;
        }

        .stats-item {
            font-size: 14px;
            color: #718096;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        /* 操作指南样式 */
        .guidance-card {
            background: linear-gradient(135deg, #f7fafc, #edf2ff);
        }

        .guidance-steps {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .step-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .step-desc {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        /* 操作按钮区域 */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            margin: 24px -24px -24px -24px;
            border-top: 1px solid #e2e8f0;
            background: #fafbfc;
        }

        .action-left,
        .action-right {
            display: flex;
            gap: 8px;
        }

        /* 右侧辅助面板样式 */
        .rule-sidebar {
            width: 320px;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .sidebar-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .sidebar-card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #fafbfc;
        }

        .sidebar-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .sidebar-card-content {
            padding: 16px 20px;
        }

        /* 模板列表样式 */
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .template-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .template-item:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-1px);
        }

        .template-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .template-content {
            flex: 1;
            min-width: 0;
        }

        .template-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .template-desc {
            font-size: 12px;
            color: #718096;
            line-height: 1.3;
        }

        .template-action {
            color: #cbd5e0;
            font-size: 12px;
            flex-shrink: 0;
        }

        .template-item:hover .template-action {
            color: #667eea;
        }

        /* 字段列表样式 */
        .field-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
        }

        .field-item:hover {
            background: #edf2ff;
            transform: translateX(2px);
        }

        .field-name {
            font-size: 13px;
            color: #2d3748;
            font-weight: 500;
        }

        .field-type {
            font-size: 11px;
            color: #718096;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* 帮助内容样式 */
        .help-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .help-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .help-title {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .help-desc {
            font-size: 12px;
            color: #718096;
            line-height: 1.4;
        }

        .help-actions {
            display: flex;
            justify-content: center;
        }

        /* 图标样式 */
        .icon-info::before { content: "i"; }
        .icon-arrow-right::before { content: "→"; }
        .icon-plus::before { content: "+"; }
        .icon-edit::before { content: "✎"; }
        .icon-trash::before { content: "×"; }
        .icon-copy::before { content: "⧉"; }
        .icon-check::before { content: "✓"; }
        .icon-table::before { content: "⊞"; }
        .icon-arrow-left::before { content: "←"; }
        .icon-refresh::before { content: "↻"; }
        .icon-play::before { content: "▶"; }
        .icon-save::before { content: "⊡"; }
        .icon-template::before { content: "⊞"; }
        .icon-history::before { content: "⟲"; }
        .icon-help::before { content: "?"; }
        .icon-external::before { content: "↗"; }
        .icon-filter::before { content: "⌕"; }
        .icon-target::before { content: "⊙"; }
        .icon-hash::before { content: "#"; }
        .icon-settings::before { content: "⚙"; }
        .icon-file-text::before { content: "⊡"; }

        .add-condition-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .add-condition-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f7fafc;
        }

        /* 决策表 */
        .decision-table {
            overflow-x: auto;
        }

        .decision-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .decision-table th {
            background: #f7fafc;
            padding: 10px;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 13px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .decision-table td {
            padding: 8px;
            border: 1px solid #e2e8f0;
        }

        .decision-table input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }

        .decision-table .add-row {
            text-align: center;
            padding: 12px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .decision-table .add-row:hover {
            background: #edf2ff;
            color: #667eea;
        }

        /* 工作流设计器 */
        .workflow-designer {
            display: grid;
            grid-template-columns: 200px 1fr 300px;
            gap: 20px;
            height: 700px;
        }

        .workflow-toolbox {
            background: white;
            border-radius: 8px;
            padding: 16px;
            height: 100%;
            overflow-y: auto;
        }

        .workflow-canvas {
            background: white;
            border-radius: 8px;
            position: relative;
            overflow: auto;
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .workflow-properties {
            background: white;
            border-radius: 8px;
            padding: 16px;
            height: 100%;
            overflow-y: auto;
        }

        .tool-item {
            padding: 10px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .tool-item:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }

        .tool-item:active {
            cursor: grabbing;
        }

        .workflow-node {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: move;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-width: 120px;
            text-align: center;
            font-size: 14px;
        }

        .workflow-node:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .workflow-node.selected {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        }

        .workflow-node.start {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .workflow-node.end {
            background: #fed7d7;
            border-color: #f56565;
        }

        .workflow-node.decision {
            background: #feebc8;
            border-color: #ed8936;
            transform: rotate(45deg);
            padding: 20px;
        }

        .workflow-node.decision .node-text {
            transform: rotate(-45deg);
        }

        .workflow-connection {
            position: absolute;
            background: #667eea;
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
        }

        /* 测试中心 */
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .test-input {
            background: white;
            border-radius: 8px;
            padding: 24px;
        }

        .test-output {
            background: white;
            border-radius: 8px;
            padding: 24px;
        }

        .test-log {
            background: #1a202c;
            color: #68d391;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            height: 300px;
            overflow-y: auto;
        }

        .test-log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d3748;
        }

        .test-log-time {
            color: #718096;
            font-size: 12px;
        }

        .test-log-success {
            color: #68d391;
        }

        .test-log-error {
            color: #fc8181;
        }

        .test-log-warning {
            color: #f6e05e;
        }

        /* 报告页面 */
        .report-filters {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .chart {
            height: 300px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            border-bottom: 2px solid #e2e8f0;
            padding: 0 20px;
        }

        .chart-bar {
            width: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .chart-bar:hover {
            transform: scaleY(1.05);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #718096;
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: 600;
            color: #2d3748;
        }

        /* 审核界面 */
        .review-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        .review-list {
            background: white;
            border-radius: 8px;
            padding: 16px;
            overflow-y: auto;
        }

        .review-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .review-item:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .review-item.active {
            background: #edf2ff;
            border-color: #667eea;
        }

        .review-viewer {
            background: white;
            border-radius: 8px;
            padding: 24px;
            overflow-y: auto;
        }

        .review-actions {
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }

        .review-timeline {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .timeline-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #edf2ff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-time {
            font-size: 12px;
            color: #718096;
        }

        .timeline-text {
            font-size: 14px;
            color: #2d3748;
            margin-top: 4px;
        }

        /* 标签管理 */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            min-height: 40px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #edf2ff;
            color: #667eea;
            border-radius: 4px;
            font-size: 13px;
        }

        .tag-remove {
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.3s;
        }

        .tag-remove:hover {
            color: #f56565;
        }

        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            font-size: 14px;
        }

        /* 提示信息 */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideInUp 0.3s ease-out;
            z-index: 2000;
        }

        .toast.active {
            display: flex;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast.success .toast-icon {
            background: #c6f6d5;
            color: #22543d;
        }

        .toast.error .toast-icon {
            background: #fed7d7;
            color: #742a2a;
        }

        .toast.warning .toast-icon {
            background: #feebc8;
            color: #744210;
        }

        .toast.info .toast-icon {
            background: #bee3f8;
            color: #2a4e7c;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #2d3748;
        }

        .toast-close {
            cursor: pointer;
            color: #a0aec0;
            transition: color 0.3s;
        }

        .toast-close:hover {
            color: #4a5568;
        }
    </style>
</head>

<body>
    <!-- 加载动画 -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
    </div>

    <!-- 头部导航 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span style="font-weight: bold; font-size: 24px; color: #667eea;">+</span>
                <span>医保规则管理系统</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-page="dashboard">规则库</div>
                <div class="nav-item" data-page="builder">规则构建</div>
                <div class="nav-item" data-page="workflow">工作流</div>
                <div class="nav-item" data-page="review">审核中心</div>
                <div class="nav-item" data-page="test">测试中心</div>
                <div class="nav-item" data-page="reports">分析报告</div>
            </nav>
            <div class="user-info">
                <div class="notification-btn">
                    <span style="font-size: 18px;">&#x1F514;</span>
                    <span class="notification-badge">3</span>
                </div>
                <div class="user-avatar">
                    <div class="avatar">张</div>
                    <span>张医生</span>
                    <span>▼</span>
                </div>
            </div>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 规则库页面 -->
        <div id="dashboard" class="page active">
            <div class="breadcrumb">
                <span class="breadcrumb-item">首页</span>
                <span>›</span>
                <span class="breadcrumb-item">规则库</span>
            </div>

            <div class="dashboard-layout">
                <!-- 侧边栏 -->
                <aside class="sidebar">
                    <h3 class="sidebar-title">规则分类</h3>
                    <div class="folder-tree">
                        <div class="folder expanded">
                            <div class="folder-header">
                                <span class="folder-icon">▶</span>
                                <span>事前审核</span>
                                <span class="folder-count">423</span>
                            </div>
                            <div class="folder-children">
                                <div class="folder-header active">
                                    <span style="margin-left: 24px">药品规则</span>
                                    <span class="folder-count">156</span>
                                </div>
                                <div class="folder-header">
                                    <span style="margin-left: 24px">诊疗项目</span>
                                    <span class="folder-count">89</span>
                                </div>
                                <div class="folder-header">
                                    <span style="margin-left: 24px">医保政策</span>
                                    <span class="folder-count">178</span>
                                </div>
                            </div>
                        </div>
                        <div class="folder">
                            <div class="folder-header">
                                <span class="folder-icon">▶</span>
                                <span>事中审核</span>
                                <span class="folder-count">312</span>
                            </div>
                            <div class="folder-children">
                                <div class="folder-header">
                                    <span style="margin-left: 24px">实时监控</span>
                                    <span class="folder-count">145</span>
                                </div>
                                <div class="folder-header">
                                    <span style="margin-left: 24px">异常预警</span>
                                    <span class="folder-count">167</span>
                                </div>
                            </div>
                        </div>
                        <div class="folder">
                            <div class="folder-header">
                                <span class="folder-icon">▶</span>
                                <span>事后审核</span>
                                <span class="folder-count">552</span>
                            </div>
                            <div class="folder-children">
                                <div class="folder-header">
                                    <span style="margin-left: 24px">慢病管理</span>
                                    <span class="folder-count">234</span>
                                </div>
                                <div class="folder-header">
                                    <span style="margin-left: 24px">DRG分组</span>
                                    <span class="folder-count">318</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <h3 class="sidebar-title">快速筛选</h3>
                        <div style="margin-top: 10px;">
                            <label class="form-checkbox-item">
                                <input type="checkbox">
                                <span>仅显示激活</span>
                            </label>
                            <label class="form-checkbox-item" style="margin-top: 8px;">
                                <input type="checkbox">
                                <span>我创建的</span>
                            </label>
                            <label class="form-checkbox-item" style="margin-top: 8px;">
                                <input type="checkbox">
                                <span>近期修改</span>
                            </label>
                        </div>
                    </div>
                </aside>

                <!-- 工作区 -->
                <main class="workspace">
                    <!-- 统计卡片 -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">图表</div>
                            <div class="stat-value">1,287</div>
                            <div class="stat-label">激活规则总数</div>
                            <span class="stat-change positive">+12.5%</span>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">时钟</div>
                            <div class="stat-value">23</div>
                            <div class="stat-label">待审核规则</div>
                            <span class="stat-change negative">-8.3%</span>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">热点</div>
                            <div class="stat-value">15,432</div>
                            <div class="stat-label">本周触发次数</div>
                            <span class="stat-change positive">+23.1%</span>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">检查</div>
                            <div class="stat-value">98.7%</div>
                            <div class="stat-label">规则准确率</div>
                            <span class="stat-change positive">+0.3%</span>
                        </div>
                    </div>

                    <!-- 工具栏 -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-box">
                                <span class="search-icon">搜索</span>
                                <input type="text" class="search-input" placeholder="搜索规则名称、描述或内容...">
                            </div>
                            <select class="filter-select">
                                <option>全部状态</option>
                                <option>已激活</option>
                                <option>草稿</option>
                                <option>已归档</option>
                            </select>
                            <select class="filter-select">
                                <option>全部类型</option>
                                <option>条件规则</option>
                                <option>决策表</option>
                                <option>工作流</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-secondary">
                                <span>导入</span> 导入规则
                            </button>
                            <button class="btn btn-secondary">
                                <span>导出</span> 导出规则
                            </button>
                            <button class="btn btn-primary" onclick="createNewRule()">
                                <span>新增</span> 新建规则
                            </button>
                        </div>
                    </div>

                    <!-- 数据表格 -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="table-checkbox">
                                    <input type="checkbox">
                                </th>
                                <th>规则名称</th>
                                <th>类型</th>
                                <th>状态</th>
                                <th>触发次数</th>
                                <th>最后修改人</th>
                                <th>修改时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="rulesTableBody">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>

                    <!-- 分页 -->
                    <div class="pagination">
                        <div class="pagination-info">
                            显示 1-10 条，共 156 条
                        </div>
                        <div class="pagination-controls">
                            <button class="page-btn" disabled>上一页</button>
                            <button class="page-btn active">1</button>
                            <button class="page-btn">2</button>
                            <button class="page-btn">3</button>
                            <button class="page-btn">...</button>
                            <button class="page-btn">16</button>
                            <button class="page-btn">下一页</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    </div>

    <!-- 工作流设计页面 -->
    <div id="workflow" class="page">
        <div class="breadcrumb">
            <span class="breadcrumb-item">首页</span>
            <span>›</span>
            <span class="breadcrumb-item">工作流管理</span>
            <span>›</span>
            <span class="breadcrumb-item">慢病管理流程</span>
        </div>

        <div class="workflow-designer">
            <!-- 节点工具箱 -->
            <div class="workflow-toolbox">
                <h3 class="sidebar-title">节点工具箱</h3>
                <div class="tool-item" draggable="true" data-type="start">
                    开始事件
                </div>
                <div class="tool-item" draggable="true" data-type="end">
                    结束事件
                </div>
                <div class="tool-item" draggable="true" data-type="user">
                    用户任务
                </div>
                <div class="tool-item" draggable="true" data-type="auto">
                    自动任务
                </div>
                <div class="tool-item" draggable="true" data-type="decision">
                    决策网关
                </div>
                <div class="tool-item" draggable="true" data-type="timer">
                    定时器
                </div>
                <div class="tool-item" draggable="true" data-type="email">
                    发送邮件
                </div>
            </div>

            <!-- 画布 -->
            <div class="workflow-canvas" id="workflowCanvas">
                <!-- 预设节点 -->
                <div class="workflow-node start" style="left: 50px; top: 200px;" data-node-id="1">
                    <span class="node-text">开始</span>
                </div>
                <div class="workflow-node" style="left: 200px; top: 200px;" data-node-id="2">
                    <span class="node-text">接收申请</span>
                </div>
                <div class="workflow-node" style="left: 350px; top: 200px;" data-node-id="3">
                    <span class="node-text">自动分配</span>
                </div>
                <div class="workflow-node" style="left: 500px; top: 200px;" data-node-id="4">
                    <span class="node-text">人工审核</span>
                </div>
                <div class="workflow-node decision" style="left: 650px; top: 180px;" data-node-id="5">
                    <span class="node-text">决策</span>
                </div>
                <div class="workflow-node" style="left: 800px; top: 100px;" data-node-id="6">
                    <span class="node-text">通过</span>
                </div>
                <div class="workflow-node" style="left: 800px; top: 280px;" data-node-id="7">
                    <span class="node-text">驳回</span>
                </div>
                <div class="workflow-node end" style="left: 950px; top: 200px;" data-node-id="8">
                    <span class="node-text">结束</span>
                </div>
            </div>

            <!-- 属性面板 -->
            <div class="workflow-properties">
                <h3 class="sidebar-title">节点属性</h3>
                <div id="nodeProperties" style="margin-top: 12px;">
                    <p style="color: #718096; font-size: 14px;">请选择一个节点查看属性</p>
                </div>

                <h3 class="sidebar-title" style="margin-top: 24px;">流程信息</h3>
                <div style="margin-top: 12px;">
                    <div class="form-group">
                        <label class="form-label">流程名称</label>
                        <input type="text" class="form-input" value="慢病管理审核流程">
                    </div>
                    <div class="form-group">
                        <label class="form-label">流程版本</label>
                        <input type="text" class="form-input" value="v2.1" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">流程状态</label>
                        <select class="form-select">
                            <option>草稿</option>
                            <option selected>已发布</option>
                            <option>已归档</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveWorkflow()">
                        保存流程
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="deployWorkflow()">
                        部署流程
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 审核中心页面 -->
    <div id="review" class="page">
        <div class="breadcrumb">
            <span class="breadcrumb-item">首页</span>
            <span>›</span>
            <span class="breadcrumb-item">审核中心</span>
            <span>›</span>
            <span class="breadcrumb-item">待审核任务</span>
        </div>

        <div class="review-layout">
            <!-- 任务列表 -->
            <div class="review-list">
                <h3 class="sidebar-title">待审核任务 (12)</h3>
                <div style="margin: 12px 0;">
                    <input type="text" class="form-input" placeholder="搜索患者姓名或病历号">
                </div>
                <div class="review-item active">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <strong>张某某</strong>
                        <span class="badge badge-warning">待审核</span>
                    </div>
                    <div style="font-size: 13px; color: #718096;">
                        <div>病历号：2024031501</div>
                        <div>申请类型：高血压慢病</div>
                        <div>提交时间：2小时前</div>
                    </div>
                </div>
                <div class="review-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <strong>李某某</strong>
                        <span class="badge badge-info">补充材料</span>
                    </div>
                    <div style="font-size: 13px; color: #718096;">
                        <div>病历号：2024031502</div>
                        <div>申请类型：糖尿病慢病</div>
                        <div>提交时间：3小时前</div>
                    </div>
                </div>
                <div class="review-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <strong>王某某</strong>
                        <span class="badge badge-warning">待审核</span>
                    </div>
                    <div style="font-size: 13px; color: #718096;">
                        <div>病历号：2024031503</div>
                        <div>申请类型：冠心病慢病</div>
                        <div>提交时间：5小时前</div>
                    </div>
                </div>
            </div>

            <!-- 病历查看器 -->
            <div class="review-viewer">
                <h2 style="margin-bottom: 20px;">病历详情</h2>

                <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">基本信息</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                        <div><strong>姓名：</strong>张某某</div>
                        <div><strong>性别：</strong>男</div>
                        <div><strong>年龄：</strong>58岁</div>
                        <div><strong>身份证：</strong>3301**********1234</div>
                        <div><strong>参保类型：</strong>职工医保</div>
                        <div><strong>参保地：</strong>杭州市</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">诊断信息</h3>
                    <table class="data-table">
                        <tr>
                            <th>诊断类型</th>
                            <th>诊断编码</th>
                            <th>诊断名称</th>
                            <th>诊断日期</th>
                        </tr>
                        <tr>
                            <td>主诊断</td>
                            <td>I10</td>
                            <td>原发性高血压</td>
                            <td>2024-01-15</td>
                        </tr>
                        <tr>
                            <td>次诊断</td>
                            <td>E78.5</td>
                            <td>高脂血症</td>
                            <td>2024-01-15</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">用药方案</h3>
                    <table class="data-table">
                        <tr>
                            <th>药品名称</th>
                            <th>规格</th>
                            <th>用法用量</th>
                            <th>天数</th>
                        </tr>
                        <tr>
                            <td>苯磺酸氨氯地平片</td>
                            <td>5mg*28片</td>
                            <td>每日一次，每次1片</td>
                            <td>30天</td>
                        </tr>
                        <tr>
                            <td>缬沙坦胶囊</td>
                            <td>80mg*30粒</td>
                            <td>每日一次，每次1粒</td>
                            <td>30天</td>
                        </tr>
                    </table>
                </div>

                <div>
                    <h3 style="font-size: 16px; margin-bottom: 12px;">上传材料</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div
                            style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer;">
                            <div style="font-size: 24px; margin-bottom: 4px;">报表</div>
                            <div style="font-size: 13px;">门诊病历.pdf</div>
                        </div>
                        <div
                            style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer;">
                            <div style="font-size: 24px; margin-bottom: 4px;">统计</div>
                            <div style="font-size: 13px;">检查报告.pdf</div>
                        </div>
                        <div
                            style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; text-align: center; cursor: pointer;">
                            <div style="font-size: 24px; margin-bottom: 4px;">处方</div>
                            <div style="font-size: 13px;">用药清单.pdf</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 审核操作 -->
            <div class="review-actions">
                <h3 class="sidebar-title">审核操作</h3>

                <div class="form-group">
                    <label class="form-label required">审核结论</label>
                    <select class="form-select" id="reviewDecision" onchange="updateReviewForm(this.value)">
                        <option value="">请选择</option>
                        <option value="pass">审核通过</option>
                        <option value="reject">审核不通过</option>
                        <option value="supplement">要求补充材料</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label required">审核意见</label>
                    <textarea class="form-textarea" id="reviewComment" rows="4" placeholder="请输入审核意见..."></textarea>
                </div>

                <div id="supplementForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">需补充的材料</label>
                        <div class="form-checkbox-group" style="flex-direction: column;">
                            <label class="form-checkbox-item">
                                <input type="checkbox">
                                <span>完整的门诊病历</span>
                            </label>
                            <label class="form-checkbox-item">
                                <input type="checkbox">
                                <span>近三个月检查报告</span>
                            </label>
                            <label class="form-checkbox-item">
                                <input type="checkbox">
                                <span>医生诊断证明</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;">
                        暂存
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="submitReview()">
                        提交审核
                    </button>
                </div>

                <!-- 审核历史 -->
                <div class="review-timeline">
                    <h3 class="sidebar-title">审核历史</h3>
                    <div class="timeline-item">
                        <div class="timeline-marker">记录</div>
                        <div class="timeline-content">
                            <div class="timeline-time">2024-03-15 14:30</div>
                            <div class="timeline-text">医院提交慢病申请</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker">处理中</div>
                        <div class="timeline-content">
                            <div class="timeline-time">2024-03-15 14:31</div>
                            <div class="timeline-text">系统自动分配审核任务</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker">医生</div>
                        <div class="timeline-content">
                            <div class="timeline-time">2024-03-15 16:45</div>
                            <div class="timeline-text">审核员开始审核</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 测试中心页面 -->
    <div id="test" class="page">
        <div class="breadcrumb">
            <span class="breadcrumb-item">首页</span>
            <span>›</span>
            <span class="breadcrumb-item">测试中心</span>
        </div>

        <div class="test-container">
            <!-- 操作引导 -->
            <div style="background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #0050b3;">测试中心使用指南</div>
                <div style="font-size: 14px; color: #1890ff; line-height: 1.5;">
                    1. 选择要测试的规则（如果从规则构建器跳转，会自动选择当前规则）<br>
                    2. 选择测试数据输入方式：手动输入、导入测试用例或使用历史数据<br>
                    3. 输入符合规则字段要求的测试数据<br>
                    4. 点击"执行测试"查看规则执行结果和详细日志<br>
                    5. 根据测试结果调整规则逻辑，确保规则按预期工作
                </div>
            </div>
            
            <!-- 测试输入 -->
            <div class="test-input">
                <h2 class="section-title">测试数据输入</h2>

                <div class="form-group">
                    <label class="form-label">选择测试规则</label>
                    <select class="form-select">
                        <option>阿司匹林使用规范审核</option>
                        <option>高血压慢病管理流程</option>
                        <option>DRG分组决策表</option>
                        <option>抗生素限制使用规则</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">测试数据方式</label>
                    <div class="form-checkbox-group">
                        <label class="form-checkbox-item">
                            <input type="radio" name="testType" checked>
                            <span>手动输入</span>
                        </label>
                        <label class="form-checkbox-item">
                            <input type="radio" name="testType">
                            <span>导入测试用例</span>
                        </label>
                        <label class="form-checkbox-item">
                            <input type="radio" name="testType">
                            <span>历史数据</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">测试数据</label>
                    <textarea class="form-textarea" rows="10" placeholder='输入JSON格式的测试数据，例如：
{
  "patientAge": 15,
  "drugName": "阿司匹林",
  "diagnosis": "I10",
  "dosage": "100mg",
  "duration": 7
}'></textarea>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="goBackToBuilder()">
                            ← 返回规则构建器
                        </button>
                        <button class="btn btn-secondary" onclick="goBackToDashboard()">
                            返回规则库
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="runTest()">
                            执行测试
                        </button>
                        <button class="btn btn-secondary" onclick="clearTest()">
                            清空
                        </button>
                    </div>
                </div>
            </div>

            <!-- 测试输出 -->
            <div class="test-output">
                <h2 class="section-title">测试结果输出</h2>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
                        <div>
                            <span style="font-size: 14px; color: #718096;">测试状态：</span>
                            <span class="badge badge-success">通过</span>
                        </div>
                        <div>
                            <span style="font-size: 14px; color: #718096;">执行时间：</span>
                            <strong>23ms</strong>
                        </div>
                        <div>
                            <span style="font-size: 14px; color: #718096;">触发规则：</span>
                            <strong>3条</strong>
                        </div>
                    </div>
                </div>

                <div class="test-log" id="testLog">
                    <div class="test-log-entry">
                        <span class="test-log-time">[14:32:15]</span>
                        <span class="test-log-success">开始执行测试...</span>
                    </div>
                    <div class="test-log-entry">
                        <span class="test-log-time">[14:32:15]</span>
                        <span>加载规则：阿司匹林使用规范审核</span>
                    </div>
                    <div class="test-log-entry">
                        <span class="test-log-time">[14:32:15]</span>
                        <span>验证条件：患者年龄 < 18 [通过]</span>
                    </div>
                    <div class="test-log-entry">
                        <span class="test-log-time">[14:32:15]</span>
                        <span>验证条件：药品名称 = "阿司匹林" [通过]</span>
                    </div>
                    <div class="test-log-entry">
                        <span class="test-log-time">[14:32:15]</span>
                        <span class="test-log-warning">触发动作：标记人工复核</span>
                    </div>
                    <div class="test-log-entry">
                        <span class="test-log-time">[14:32:15]</span>
                        <span class="test-log-success">测试完成！规则执行正常。</span>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">详细结果</h3>
                    <div style="background: #f7fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                        <pre style="margin: 0; font-family: 'Courier New', monospace;">{
  "result": "TRIGGERED",
  "actions": [
    {
      "type": "MANUAL_REVIEW",
      "reason": "未成年患者使用阿司匹林需人工审核"
    }
  ],
  "matchedConditions": 2,
  "executionTime": "23ms"
}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析报告页面 -->
    <div id="reports" class="page">
        <div class="breadcrumb">
            <span class="breadcrumb-item">首页</span>
            <span>›</span>
            <span class="breadcrumb-item">分析报告</span>
        </div>

        <!-- 报告筛选 -->
        <div class="report-filters">
            <div class="form-group" style="margin: 0;">
                <label class="form-label">时间范围</label>
                <select class="form-select">
                    <option>最近7天</option>
                    <option>最近30天</option>
                    <option>最近3个月</option>
                    <option>自定义范围</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">规则类型</label>
                <select class="form-select">
                    <option>全部类型</option>
                    <option>条件规则</option>
                    <option>决策表</option>
                    <option>工作流</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0;">
                <label class="form-label">审核阶段</label>
                <select class="form-select">
                    <option>全部阶段</option>
                    <option>事前审核</option>
                    <option>事中审核</option>
                    <option>事后审核</option>
                </select>
            </div>
            <button class="btn btn-primary">
                生成报告
            </button>
            <button class="btn btn-secondary">
                导出Excel
            </button>
        </div>

        <!-- 统计概览 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">命中</div>
                <div class="stat-value">42,156</div>
                <div class="stat-label">规则触发总次数</div>
                <span class="stat-change positive">+18.2%</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon">预警</div>
                <div class="stat-value">3,847</div>
                <div class="stat-label">异常拦截次数</div>
                <span class="stat-change positive">+24.5%</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon">金额</div>
                <div class="stat-value">￥156.8万</div>
                <div class="stat-label">节省医保基金</div>
                <span class="stat-change positive">+31.2%</span>
            </div>
            <div class="stat-card">
                <div class="stat-icon">效率</div>
                <div class="stat-value">12.3ms</div>
                <div class="stat-label">平均响应时间</div>
                <span class="stat-change positive">-15.6%</span>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">规则触发趋势</h3>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-secondary">日</button>
                    <button class="btn btn-sm btn-secondary">周</button>
                    <button class="btn btn-sm btn-secondary">月</button>
                </div>
            </div>
            <div class="chart">
                <div class="chart-bar" style="height: 60%;">
                    <span class="chart-bar-value">8,234</span>
                    <span class="chart-bar-label">周一</span>
                </div>
                <div class="chart-bar" style="height: 75%;">
                    <span class="chart-bar-value">10,456</span>
                    <span class="chart-bar-label">周二</span>
                </div>
                <div class="chart-bar" style="height: 85%;">
                    <span class="chart-bar-value">12,123</span>
                    <span class="chart-bar-label">周三</span>
                </div>
                <div class="chart-bar" style="height: 70%;">
                    <span class="chart-bar-value">9,876</span>
                    <span class="chart-bar-label">周四</span>
                </div>
                <div class="chart-bar" style="height: 90%;">
                    <span class="chart-bar-value">13,234</span>
                    <span class="chart-bar-label">周五</span>
                </div>
                <div class="chart-bar" style="height: 45%;">
                    <span class="chart-bar-value">5,123</span>
                    <span class="chart-bar-label">周六</span>
                </div>
                <div class="chart-bar" style="height: 30%;">
                    <span class="chart-bar-value">3,110</span>
                    <span class="chart-bar-label">周日</span>
                </div>
            </div>
        </div>

        <!-- TOP规则表格 -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">触发次数TOP10规则</h3>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>规则名称</th>
                        <th>类型</th>
                        <th>触发次数</th>
                        <th>拦截率</th>
                        <th>趋势</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>抗生素限制使用规则</td>
                        <td>条件规则</td>
                        <td>5,234</td>
                        <td>23.4%</td>
                        <td><span style="color: #48bb78;">↑ 12%</span></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>重复用药检查</td>
                        <td>条件规则</td>
                        <td>4,876</td>
                        <td>18.7%</td>
                        <td><span style="color: #48bb78;">↑ 8%</span></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>DRG分组规则</td>
                        <td>决策表</td>
                        <td>3,452</td>
                        <td>15.2%</td>
                        <td><span style="color: #f56565;">↓ 3%</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    </div>

    <!-- 模态框 -->
    <div class="modal" id="newRuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">新建规则</h2>
                <button class="modal-close" onclick="closeModal('newRuleModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">规则类型</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s;"
                            onclick="selectNewRuleType(this, 'condition')">
                            <div style="font-size: 32px; margin-bottom: 8px; font-family: Arial;">设置</div>
                            <div style="font-weight: 600;">条件规则</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">IF-THEN逻辑判断</div>
                        </div>
                        <div style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s;"
                            onclick="selectNewRuleType(this, 'decision')">
                            <div style="font-size: 32px; margin-bottom: 8px; font-family: Arial;">清单</div>
                            <div style="font-weight: 600;">决策表</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">批量规则管理</div>
                        </div>
                        <div style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s;"
                            onclick="selectNewRuleType(this, 'workflow')">
                            <div style="font-size: 32px; margin-bottom: 8px; font-family: Arial;">流程</div>
                            <div style="font-weight: 600;">工作流</div>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">多步骤审核流程</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">选择模板（可选）</label>
                    <select class="form-select">
                        <option>不使用模板</option>
                        <option>药品使用规范模板</option>
                        <option>慢病管理模板</option>
                        <option>DRG分组模板</option>
                        <option>费用控制模板</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newRuleModal')">取消</button>
                <button class="btn btn-primary" onclick="startCreateRule()">开始创建</button>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div class="toast" id="toast">
        <div class="toast-icon">√</div>
        <div class="toast-message">操作成功</div>
        <div class="toast-close" onclick="hideToast()">×</div>
    </div>

    <script>
        // 全局状态管理
        let currentPage = 'dashboard';
        let selectedRuleType = 'condition';
        let workflowNodes = [];
        let workflowConnections = [];

        // localStorage 管理
        function saveRulesToStorage() {
            try {
                localStorage.setItem('rulesData', JSON.stringify(rulesData));
            } catch (e) {
                console.error('保存规则到本地存储失败:', e);
            }
        }

        function loadRulesFromStorage() {
            try {
                const stored = localStorage.getItem('rulesData');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.error('从本地存储加载规则失败:', e);
            }
            return getDefaultRulesData();
        }

        function getDefaultRulesData() {
            return [
                {
                    id: 1,
                    name: '阿司匹林使用规范审核',
                    type: '条件规则',
                    status: 'active',
                    triggers: '1,234',
                    modifier: '张医生',
                    modifyTime: '2024-03-15 14:30'
                },
                {
                    id: 2,
                    name: '高血压慢病管理流程',
                    type: '工作流',
                    status: 'active',
                    triggers: '856',
                    modifier: '李主任',
                    modifyTime: '2024-03-14 09:15'
                },
                {
                    id: 3,
                    name: 'DRG分组决策表',
                    type: '决策表',
                    status: 'draft',
                    triggers: '0',
                    modifier: '王专员',
                    modifyTime: '2024-03-13 16:45'
                },
                {
                    id: 4,
                    name: '抗生素限制使用规则',
                    type: '条件规则',
                    status: 'active',
                    triggers: '2,456',
                    modifier: '陈医生',
                    modifyTime: '2024-03-12 11:20'
                },
                {
                    id: 5,
                    name: '重复用药检查',
                    type: '条件规则',
                    status: 'active',
                    triggers: '892',
                    modifier: '刘护士',
                    modifyTime: '2024-03-11 13:10'
                }
            ];
        }

        // 示例数据
        let rulesData = loadRulesFromStorage();
        let nextRuleId = Math.max(...rulesData.map(r => r.id || 0)) + 1;

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        function initializeApp() {
            // 设置默认页面
            document.getElementById('dashboard').classList.add('active');
            document.querySelector('.nav-item[data-page="dashboard"]').classList.add('active');
            currentPage = 'dashboard';
            
            // 加载规则数据
            loadRulesTable();

            // 绑定导航事件
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function () {
                    const page = this.dataset.page;
                    navigateToPage(page);
                });
            });

            // 绑定文件夹展开/折叠
            document.querySelectorAll('.folder-header').forEach(header => {
                header.addEventListener('click', function (e) {
                    if (!e.target.closest('.folder-count')) {
                        const folder = this.closest('.folder');
                        if (folder) {
                            folder.classList.toggle('expanded');
                        }
                        // 更新激活状态
                        document.querySelectorAll('.folder-header').forEach(h => h.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });

            // 初始化工作流设计器
            initWorkflowDesigner();
            
            // 初始化规则构建器
            initRuleBuilder();
        }

        // 页面导航
        function navigateToPage(pageId) {
            // 显示加载动画
            showLoader();

            setTimeout(() => {
                // 隐藏所有页面（移除 active 并清理可能残留的内联样式）
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = '';
                });

                // 显示目标页面（统一使用 active 类控制显示）
                const target = document.getElementById(pageId);
                if (target) {
                    target.classList.add('active');
                    target.style.display = '';
                }

                // 更新导航激活状态
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === pageId) {
                        item.classList.add('active');
                    }
                });

                currentPage = pageId;

                // 页面特定初始化
                if (pageId === 'workflow') {
                    renderWorkflowCanvas();
                }
                
                // 如果进入构建器并有已选择的规则类型，确保界面与状态同步
                if (pageId === 'builder') {
                    const typeSelect = document.getElementById('ruleType');
                    const chosenType = typeSelect?.value || selectedRuleType || 'condition';
                    if (typeSelect) typeSelect.value = chosenType;
                    switchRuleType(chosenType);
                    const typeOptions = document.querySelectorAll('#builder .rule-type-option');
                    typeOptions.forEach(opt => {
                        if (opt.dataset.type === chosenType) opt.classList.add('selected');
                        else opt.classList.remove('selected');
                    });
                }

                hideLoader();
            }, 300);
        }

        // 加载规则表格数据
        function loadRulesTable() {
            const tbody = document.getElementById('rulesTableBody');
            if (!tbody) return;

            tbody.innerHTML = rulesData.map((rule, index) => `
                <tr>
                    <td class="table-checkbox">
                        <input type="checkbox" data-id="${rule.id || ''}">
                    </td>
                    <td>
                        <div style="font-weight: 500;">${rule.name}</div>
                    </td>
                    <td>${rule.type}</td>
                    <td>
                        <span class="badge badge-${rule.status === 'active' ? 'success' : rule.status === 'draft' ? 'warning' : 'info'}">
                            ${rule.status === 'active' ? '已激活' : rule.status === 'draft' ? '草稿' : '已归档'}
                        </span>
                    </td>
                    <td>${rule.triggers}</td>
                    <td>${rule.modifier}</td>
                    <td>${rule.modifyTime}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editRule(${index})">编辑</button>
                        <button class="btn btn-sm btn-secondary" onclick="copyRule(${index})">复制</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteRule(${index})">删除</button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleRuleStatus(${index})">${rule.status === 'active' ? '停用' : '激活'}</button>
                        <button class="btn btn-sm btn-secondary" onclick="testRule(${index})">测试</button>
                        <button class="btn btn-sm btn-secondary" onclick="viewRule(${index})">查看</button>
                    </td>
                </tr>
            `).join('');

            // 重新绑定全选功能
            const selectAllCheckbox = document.querySelector('.data-table th .table-checkbox input');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function (e) {
                    const checkboxes = document.querySelectorAll('#rulesTableBody .table-checkbox input');
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                });
            }
        }

        // 创建新规则
        function createNewRule() {
            document.getElementById('newRuleModal').classList.add('active');
        }



        function startCreateRule() {
            closeModal('newRuleModal');

            if (selectedRuleType === 'workflow') {
                navigateToPage('workflow');
            } else {
                navigateToPage('builder');
                // 根据选择的类型切换表单（不再只处理 decision）
                const chosenType = selectedRuleType || 'condition';
                const ruleTypeInput = document.getElementById('ruleType');
                if (ruleTypeInput) {
                    ruleTypeInput.value = chosenType;
                }
                // 切换可见区域
                switchRuleType(chosenType);
                // 同步左侧“规则类型”选项的选中样式
                const typeOptions = document.querySelectorAll('#builder .rule-type-option');
                typeOptions.forEach(opt => {
                    if (opt.dataset.type === chosenType) opt.classList.add('selected');
                    else opt.classList.remove('selected');
                });
            }

            showToast('success', '开始创建新规则');
        }

        // 规则构建器功能
        function switchRuleType(type) {
            // 隐藏所有规则配置区域
            const sections = ['conditionRuleSection', 'decisionTableSection', 'workflowRuleSection', 'scoringRuleSection', 'thresholdRuleSection', 'frequencyRuleSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) section.style.display = 'none';
            });
            
            // 显示对应的规则配置区域
            let targetSection = null;
            switch(type) {
                case 'condition':
                    targetSection = document.getElementById('conditionRuleSection');
                    break;
                case 'decision':
                    targetSection = document.getElementById('decisionTableSection');
                    break;
                case 'workflow':
                    targetSection = document.getElementById('workflowRuleSection');
                    break;
                case 'scoring':
                    targetSection = document.getElementById('scoringRuleSection');
                    break;
                case 'threshold':
                    targetSection = document.getElementById('thresholdRuleSection');
                    break;
                case 'frequency':
                    targetSection = document.getElementById('frequencyRuleSection');
                    break;
                default:
                    targetSection = document.getElementById('conditionRuleSection');
            }
            
            // 确保目标区域存在并显示
            if (targetSection) {
                targetSection.style.display = 'block';
                showToast('info', `已切换到${getRuleTypeName(type)}配置`);
            } else {
                console.error(`规则配置区域不存在: ${type}`);
                showToast('error', `切换失败：${getRuleTypeName(type)}配置区域不存在`);
            }
        }
        
        function getRuleTypeName(type) {
            const typeNames = {
                'condition': '条件规则',
                'decision': '决策表',
                'workflow': '工作流规则',
                'scoring': '评分规则',
                'threshold': '阈值规则',
                'frequency': '频次规则'
            };
            return typeNames[type] || '条件规则';
        }

        function toggleLogic(element, logic) {
            const container = element.parentElement;
            container.querySelectorAll('.logic-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        function addCondition() {
            const container = document.getElementById('conditionsContainer');
            const group = container.querySelector('.condition-group:last-child');

            const newRow = document.createElement('div');
            newRow.className = 'condition-row';
            newRow.innerHTML = `
                <select class="form-select">
                    <option>请选择字段</option>
                    <optgroup label="患者信息">
                        <option>患者年龄</option>
                        <option>患者性别</option>
                    </optgroup>
                    <optgroup label="药品信息">
                        <option>药品名称</option>
                        <option>药品编码</option>
                    </optgroup>
                </select>
                <select class="form-select">
                    <option>等于</option>
                    <option>不等于</option>
                    <option>大于</option>
                    <option>小于</option>
                </select>
                <input type="text" class="form-input" placeholder="请输入值">
                <button class="remove-btn" onclick="removeCondition(this)">×</button>
            `;

            group.appendChild(newRow);
            showToast('success', '已添加新条件');
        }

        function addConditionGroup() {
            const container = document.getElementById('conditionsContainer');

            const newGroup = document.createElement('div');
            newGroup.className = 'condition-group nested';
            newGroup.innerHTML = `
                <div class="condition-logic">
                    <span>当满足</span>
                    <div class="logic-switch">
                        <span class="logic-option active" onclick="toggleLogic(this, 'AND')">所有条件 (AND)</span>
                        <span class="logic-option" onclick="toggleLogic(this, 'OR')">任一条件 (OR)</span>
                    </div>
                    <span>时：</span>
                </div>
                <div class="condition-row">
                    <select class="form-select">
                        <option>请选择字段</option>
                        <optgroup label="患者信息">
                            <option>患者年龄</option>
                            <option>患者性别</option>
                        </optgroup>
                    </select>
                    <select class="form-select">
                        <option>等于</option>
                        <option>不等于</option>
                    </select>
                    <input type="text" class="form-input" placeholder="请输入值">
                    <button class="remove-btn" onclick="removeCondition(this)">×</button>
                </div>
            `;

            container.appendChild(newGroup);
            showToast('success', '已添加新条件组');
        }

        function removeCondition(button) {
            const row = button.closest('.condition-row');
            const group = button.closest('.condition-group');

            // 如果组内只有一个条件，删除整个组
            if (group.querySelectorAll('.condition-row').length === 1 && group.classList.contains('nested')) {
                group.remove();
            } else {
                row.remove();
            }

            showToast('info', '已删除条件');
        }

        function addAction() {
            const container = document.getElementById('actionsContainer');

            const newAction = document.createElement('div');
            newAction.className = 'condition-group';
            newAction.innerHTML = `
                <div class="condition-row">
                    <select class="form-select" style="grid-column: 1/3;">
                        <option>请选择动作</option>
                        <option>标记人工复核</option>
                        <option>拒绝结算</option>
                        <option>发送通知</option>
                    </select>
                    <input type="text" class="form-input" placeholder="动作参数" style="grid-column: 3/4;">
                    <button class="remove-btn" onclick="removeAction(this)">×</button>
                </div>
            `;

            container.appendChild(newAction);
            showToast('success', '已添加新动作');
        }

        function removeAction(button) {
            button.closest('.condition-group').remove();
            showToast('info', '已删除动作');
        }

        function addDecisionRow() {
            const table = document.querySelector('.decision-table tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><button class="remove-btn" onclick="this.closest('tr').remove()">×</button></td>
            `;

            table.insertBefore(newRow, table.querySelector('.add-row'));
            showToast('success', '已添加新行');
        }
        
        // 规则类型配置函数已统一到switchRuleType中处理

        // 创建各种规则类型的配置界面（已移至静态HTML结构）

        

        
        // 标签管理
        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();

                if (value) {
                    const container = document.getElementById('tagContainer');
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.innerHTML = `
                        ${value}
                        <span class="tag-remove" onclick="this.parentElement.remove()">×</span>
                    `;

                    container.insertBefore(tag, input);
                    input.value = '';
                    showToast('success', `已添加标签: ${value}`);
                }
            }
        }
        
        // 新规则类型的辅助函数
        function addScoringFactor() {
            const container = document.getElementById('scoringFactors');
            const factorItem = document.createElement('div');
            factorItem.className = 'factor-item';
            factorItem.innerHTML = `
                <div class="form-group">
                    <label class="form-label">评分因子</label>
                    <select class="form-select">
                        <option>患者年龄</option>
                        <option>费用金额</option>
                        <option>住院天数</option>
                        <option>药品种类数</option>
                        <option>诊断类型</option>
                        <option>手术复杂度</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">权重</label>
                    <input type="number" class="form-input" value="1" min="0" max="10" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">评分规则</label>
                    <textarea class="form-textarea" placeholder="例如：年龄>65岁得3分，50-65岁得2分，<50岁得1分"></textarea>
                </div>
                <button class="remove-btn" onclick="removeScoringFactor(this)">×</button>
            `;
            container.appendChild(factorItem);
            showToast('success', '已添加评分因子');
        }
        
        function removeScoringFactor(button) {
            const factorItem = button.closest('.factor-item');
            factorItem.remove();
            showToast('success', '已删除评分因子');
        }
        
        function addThresholdRule() {
            const container = document.getElementById('thresholdRules');
            const ruleItem = document.createElement('div');
            ruleItem.className = 'threshold-rule-item';
            ruleItem.innerHTML = `
                <div class="form-group">
                    <label class="form-label">监控指标</label>
                    <select class="form-select">
                        <option>单次费用金额</option>
                        <option>住院天数</option>
                        <option>药品费用占比</option>
                        <option>检查费用</option>
                        <option>手术费用</option>
                        <option>材料费用</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">阈值类型</label>
                    <select class="form-select" onchange="updateThresholdInputs(this)">
                        <option value="single">单一阈值</option>
                        <option value="range">范围阈值</option>
                        <option value="percentage">百分比阈值</option>
                    </select>
                </div>
                <div class="threshold-inputs">
                    <div class="form-group">
                        <label class="form-label">阈值</label>
                        <input type="number" class="form-input" placeholder="输入阈值">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">触发条件</label>
                    <select class="form-select">
                        <option value="greater">大于阈值</option>
                        <option value="less">小于阈值</option>
                        <option value="equal">等于阈值</option>
                        <option value="between">在范围内</option>
                        <option value="outside">在范围外</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">触发动作</label>
                    <select class="form-select">
                        <option>标记人工复核</option>
                        <option>自动拒绝</option>
                        <option>发送警告</option>
                        <option>降低支付比例</option>
                    </select>
                </div>
                <button class="remove-btn" onclick="removeThresholdRule(this)">×</button>
            `;
            container.appendChild(ruleItem);
            showToast('success', '已添加阈值规则');
        }
        
        function removeThresholdRule(button) {
            const ruleItem = button.closest('.threshold-rule-item');
            ruleItem.remove();
            showToast('success', '已删除阈值规则');
        }
        
        function updateThresholdInputs(select) {
            const thresholdInputs = select.closest('.threshold-rule-item').querySelector('.threshold-inputs');
            const type = select.value;
            
            if (type === 'range') {
                thresholdInputs.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">最小值</label>
                        <input type="number" class="form-input" placeholder="最小阈值">
                    </div>
                    <div class="form-group">
                        <label class="form-label">最大值</label>
                        <input type="number" class="form-input" placeholder="最大阈值">
                    </div>
                `;
            } else if (type === 'percentage') {
                thresholdInputs.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">百分比阈值</label>
                        <input type="number" class="form-input" placeholder="输入百分比" min="0" max="100" step="0.1">
                        <span>%</span>
                    </div>
                `;
            } else {
                thresholdInputs.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">阈值</label>
                        <input type="number" class="form-input" placeholder="输入阈值">
                    </div>
                `;
            }
        }
        
        function addWorkflowNode(nodeType) {
            const canvas = document.getElementById('workflowCanvas');
            if (!canvas) return;
            
            const nodeCount = canvas.querySelectorAll('.workflow-node').length;
            const node = document.createElement('div');
            node.className = `workflow-node ${nodeType}-node`;
            node.style.position = 'absolute';
            node.style.top = (50 + nodeCount * 100) + 'px';
            node.style.left = (100 + (nodeCount % 3) * 200) + 'px';
            
            let nodeContent = '';
            switch(nodeType) {
                case 'start':
                    nodeContent = '<div class="node-header">开始</div><div class="node-content">规则触发</div>';
                    break;
                case 'condition':
                    nodeContent = '<div class="node-header">条件</div><div class="node-content">判断条件</div>';
                    break;
                case 'action':
                    nodeContent = '<div class="node-header">动作</div><div class="node-content">执行动作</div>';
                    break;
                case 'end':
                    nodeContent = '<div class="node-header">结束</div><div class="node-content">流程结束</div>';
                    break;
            }
            
            node.innerHTML = nodeContent;
            canvas.appendChild(node);
            showToast('success', `已添加${nodeType}节点`);
        }

        // 工作流设计器
        function initWorkflowDesigner() {
            const canvas = document.getElementById('workflowCanvas');
            if (!canvas) return;

            // 节点选择
            canvas.addEventListener('click', function (e) {
                const node = e.target.closest('.workflow-node');
                if (node) {
                    selectWorkflowNode(node);
                }
            });

            // 节点拖拽
            let isDragging = false;
            let currentNode = null;
            let offsetX = 0;
            let offsetY = 0;

            canvas.addEventListener('mousedown', function (e) {
                const node = e.target.closest('.workflow-node');
                if (node) {
                    isDragging = true;
                    currentNode = node;
                    const rect = node.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;
                    node.style.zIndex = 1000;
                }
            });

            document.addEventListener('mousemove', function (e) {
                if (isDragging && currentNode) {
                    const canvasRect = canvas.getBoundingClientRect();
                    const x = e.clientX - canvasRect.left - offsetX;
                    const y = e.clientY - canvasRect.top - offsetY;

                    currentNode.style.left = Math.max(0, Math.min(x, canvasRect.width - 140)) + 'px';
                    currentNode.style.top = Math.max(0, Math.min(y, canvasRect.height - 60)) + 'px';
                }
            });

            document.addEventListener('mouseup', function () {
                if (currentNode) {
                    currentNode.style.zIndex = '';
                }
                isDragging = false;
                currentNode = null;
            });

            // 工具箱拖拽
            document.querySelectorAll('.tool-item').forEach(item => {
                item.addEventListener('dragstart', function (e) {
                    e.dataTransfer.setData('nodeType', this.dataset.type);
                });
            });

            canvas.addEventListener('dragover', function (e) {
                e.preventDefault();
            });

            canvas.addEventListener('drop', function (e) {
                e.preventDefault();
                const nodeType = e.dataTransfer.getData('nodeType');
                const canvasRect = canvas.getBoundingClientRect();
                const x = e.clientX - canvasRect.left - 60;
                const y = e.clientY - canvasRect.top - 20;

                addWorkflowNode(nodeType, x, y);
            });
        }

        function selectWorkflowNode(node) {
            // 清除其他选中状态
            document.querySelectorAll('.workflow-node').forEach(n => {
                n.classList.remove('selected');
            });

            // 设置选中状态
            node.classList.add('selected');

            // 更新属性面板
            updateNodeProperties(node);
        }

        function updateNodeProperties(node) {
            const propertiesPanel = document.getElementById('nodeProperties');
            const nodeId = node.dataset.nodeId;
            const nodeText = node.querySelector('.node-text').textContent;

            propertiesPanel.innerHTML = `
                <div class="form-group">
                    <label class="form-label">节点名称</label>
                    <input type="text" class="form-input" value="${nodeText}" onchange="updateNodeName(${nodeId}, this.value)">
                </div>
                <div class="form-group">
                    <label class="form-label">节点类型</label>
                    <select class="form-select">
                        <option>用户任务</option>
                        <option>自动任务</option>
                        <option>决策网关</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">执行人/角色</label>
                    <select class="form-select">
                        <option>医保专员</option>
                        <option>第三方审核员</option>
                        <option>医院医保办</option>
                        <option>系统自动</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">超时设置</label>
                    <input type="text" class="form-input" placeholder="例如: 24小时">
                </div>
            `;
        }

        function addWorkflowNode(type, x, y) {
            const canvas = document.getElementById('workflowCanvas');
            const node = document.createElement('div');
            node.className = 'workflow-node';

            if (type === 'start') node.classList.add('start');
            if (type === 'end') node.classList.add('end');
            if (type === 'decision') node.classList.add('decision');

            const nodeId = Date.now();
            node.dataset.nodeId = nodeId;
            node.style.left = x + 'px';
            node.style.top = y + 'px';

            const typeNames = {
                start: '开始',
                end: '结束',
                user: '用户任务',
                auto: '自动任务',
                decision: '决策',
                timer: '定时器',
                email: '发送邮件'
            };

            node.innerHTML = `<span class="node-text">${typeNames[type] || '新节点'}</span>`;

            canvas.appendChild(node);
            selectWorkflowNode(node);

            showToast('success', '已添加新节点');
        }

        function renderWorkflowCanvas() {
            // 渲染连接线等
        }

        function saveWorkflow() {
            showLoader();
            setTimeout(() => {
                hideLoader();
                showToast('success', '工作流已保存');
            }, 1000);
        }

        function deployWorkflow() {
            if (confirm('确定要部署此工作流吗？部署后将立即生效。')) {
                showLoader();
                setTimeout(() => {
                    hideLoader();
                    showToast('success', '工作流部署成功');
                }, 1500);
            }
        }

        // 规则操作
        function editRule(index) {
            if (index === undefined || !rulesData[index]) {
                showToast('error', '无法找到指定的规则');
                return;
            }
            const rule = rulesData[index];
            navigateToPage('builder');

            // 填充表单
            setTimeout(() => {
                const ruleNameInput = document.getElementById('ruleName');
                const ruleDescInput = document.getElementById('ruleDesc');
                if (ruleNameInput) {
                    ruleNameInput.value = rule.name;
                }
                if (ruleDescInput) {
                    ruleDescInput.value = '这是' + rule.name + '的详细描述';
                }
                showToast('info', '正在编辑: ' + rule.name);
            }, 400);
        }

        function testRule(index) {
            // 如果从规则列表调用
            if (index !== undefined && rulesData[index]) {
                const rule = rulesData[index];
                navigateToPage('test');
                showToast('info', '准备测试: ' + rule.name);
            } else {
                // 如果从规则构建器调用
                const ruleName = document.getElementById('ruleName')?.value;
                if (!ruleName) {
                    showToast('error', '请先输入规则名称');
                    return;
                }
                navigateToPage('test');
                showToast('info', '准备测试规则');
            }
        }

        function viewRule(index) {
            if (index === undefined || !rulesData[index]) {
                showToast('error', '无法找到指定的规则');
                return;
            }
            const rule = rulesData[index];
            showToast('info', '查看规则: ' + rule.name);
        }

        function saveAsDraft() {
            const ruleName = document.getElementById('ruleName')?.value?.trim();
            const ruleType = document.getElementById('ruleType')?.value || selectedRuleType || 'condition';
            if (!ruleName) {
                showToast('error', '请输入规则名称');
                return;
            }

            // 获取规则类型的中文名称
            function getRuleTypeDisplayName(type) {
                switch(type) {
                    case 'decision': return '决策表';
                    case 'workflow': return '工作流';
                    case 'scoring': return '评分规则';
                    case 'threshold': return '阈值规则';
                    case 'frequency': return '频次规则';
                    default: return '条件规则';
                }
            }

            const editIndex = document.body.dataset.editIndex;
            if (editIndex !== undefined) {
                // 编辑现有规则
                const index = parseInt(editIndex);
                if (rulesData[index]) {
                    rulesData[index].name = ruleName;
                    rulesData[index].type = getRuleTypeDisplayName(ruleType);
                    rulesData[index].status = 'draft';
                    rulesData[index].modifier = '当前用户';
                    rulesData[index].modifyTime = new Date().toLocaleString('zh-CN');
                    document.body.removeAttribute('data-edit-index');
                }
            } else {
                // 新建规则
                const newRule = {
                    id: nextRuleId++,
                    name: ruleName,
                    type: getRuleTypeDisplayName(ruleType),
                    status: 'draft',
                    triggers: '0',
                    modifier: '当前用户',
                    modifyTime: new Date().toLocaleString('zh-CN')
                };
                rulesData.unshift(newRule);
            }
            saveRulesToStorage();

            showLoader();
            setTimeout(() => {
                hideLoader();
                showToast('success', '规则已保存为草稿');
                navigateToPage('dashboard');
                loadRulesTable();
            }, 500);
        }

        function saveAndActivate() {
            const ruleName = document.getElementById('ruleName')?.value?.trim();
            const ruleType = document.getElementById('ruleType')?.value || selectedRuleType || 'condition';
            if (!ruleName) {
                showToast('error', '请输入规则名称');
                return;
            }

            // 获取规则类型的中文名称
            function getRuleTypeDisplayName(type) {
                switch(type) {
                    case 'decision': return '决策表';
                    case 'workflow': return '工作流';
                    case 'scoring': return '评分规则';
                    case 'threshold': return '阈值规则';
                    case 'frequency': return '频次规则';
                    default: return '条件规则';
                }
            }

            const editIndex = document.body.dataset.editIndex;
            if (editIndex !== undefined) {
                // 编辑现有规则并激活
                const index = parseInt(editIndex);
                if (rulesData[index]) {
                    rulesData[index].name = ruleName;
                    rulesData[index].type = getRuleTypeDisplayName(ruleType);
                    rulesData[index].status = 'active';
                    rulesData[index].modifier = '当前用户';
                    rulesData[index].modifyTime = new Date().toLocaleString('zh-CN');
                    document.body.removeAttribute('data-edit-index');
                }
            } else {
                // 新建并激活规则
                const newRule = {
                    id: nextRuleId++,
                    name: ruleName,
                    type: getRuleTypeDisplayName(ruleType),
                    status: 'active',
                    triggers: '0',
                    modifier: '当前用户',
                    modifyTime: new Date().toLocaleString('zh-CN')
                };
                rulesData.unshift(newRule);
            }
            saveRulesToStorage();
            
            showLoader();
            setTimeout(() => {
                hideLoader();
                showToast('success', '规则已保存并激活');
                navigateToPage('dashboard');
                loadRulesTable();
            }, 600);
        }

        // 测试中心
        function runTest() {
            // 验证测试数据
            const testData = document.querySelector('.test-input textarea').value.trim();
            if (!testData) {
                showToast('warning', '请输入测试数据');
                return;
            }
            
            // 验证JSON格式
            try {
                JSON.parse(testData);
            } catch (e) {
                showToast('error', '测试数据格式错误，请输入有效的JSON格式');
                return;
            }
            
            const testLog = document.getElementById('testLog');
            testLog.innerHTML = '';

            const logs = [
                { time: new Date().toLocaleTimeString(), type: 'success', text: '开始执行测试...' },
                { time: new Date().toLocaleTimeString(), type: '', text: '加载规则配置...' },
                { time: new Date().toLocaleTimeString(), type: '', text: '解析测试数据...' },
                { time: new Date().toLocaleTimeString(), type: '', text: '验证条件: 患者年龄 < 18 [通过]' },
                { time: new Date().toLocaleTimeString(), type: '', text: '验证条件: 药品名称 = "阿司匹林" [通过]' },
                { time: new Date().toLocaleTimeString(), type: 'warning', text: '触发动作: 标记人工复核' },
                { time: new Date().toLocaleTimeString(), type: 'success', text: '测试完成！规则执行正常。' }
            ];

            logs.forEach((log, index) => {
                setTimeout(() => {
                    const entry = document.createElement('div');
                    entry.className = 'test-log-entry';
                    entry.innerHTML = `
                        <span class="test-log-time">[${log.time}]</span>
                        <span class="test-log-${log.type}">${log.text}</span>
                    `;
                    testLog.appendChild(entry);
                    testLog.scrollTop = testLog.scrollHeight;
                    
                    // 最后一条日志时显示完成提示
                    if (index === logs.length - 1) {
                        setTimeout(() => {
                            showToast('success', '测试执行完成！您可以查看详细结果或返回继续编辑规则');
                        }, 500);
                    }
                }, index * 200);
            });

            showToast('info', '正在执行测试...');
        }

        function clearTest() {
            if (confirm('确定要清空所有测试数据吗？')) {
                document.querySelector('.test-input textarea').value = '';
                document.getElementById('testLog').innerHTML = '<div class="test-log-entry"><span class="test-log-time">[' + new Date().toLocaleTimeString() + ']</span><span>等待测试...</span></div>';
                showToast('success', '测试数据已清空，您可以输入新的测试数据');
            }
        }

        // 审核中心
        function updateReviewForm(decision) {
            const supplementForm = document.getElementById('supplementForm');
            if (decision === 'supplement') {
                supplementForm.style.display = 'block';
            } else {
                supplementForm.style.display = 'none';
            }
        }

        function submitReview() {
            const decision = document.getElementById('reviewDecision').value;
            const comment = document.getElementById('reviewComment').value;

            if (!decision) {
                showToast('error', '请选择审核结论');
                return;
            }

            if (!comment) {
                showToast('error', '请输入审核意见');
                return;
            }

            if (confirm('确定要提交审核结果吗？')) {
                showLoader();
                setTimeout(() => {
                    hideLoader();
                    showToast('success', '审核结果已提交');

                    // 更新审核历史
                    const timeline = document.querySelector('.review-timeline');
                    const newItem = document.createElement('div');
                    newItem.className = 'timeline-item';
                    newItem.innerHTML = `
                        <div class="timeline-marker">完成</div>
                        <div class="timeline-content">
                            <div class="timeline-time">${new Date().toLocaleString()}</div>
                            <div class="timeline-text">审核完成: ${decision === 'pass' ? '通过' : decision === 'reject' ? '不通过' : '要求补充材料'}</div>
                        </div>
                    `;
                    timeline.appendChild(newItem);
                }, 1000);
            }
        }

        // 模板加载
        function loadTemplate(type) {
            if (type === 'drug') {
                document.getElementById('ruleName').value = '抗生素使用规范';
                document.getElementById('ruleDesc').value = '根据最新医保政策，对抗生素的使用进行规范性审核';
                showToast('success', '已加载抗生素使用规范模板');
            } else if (type === 'drg') {
                document.getElementById('ruleType').value = 'decision';
                switchRuleType('decision');
                showToast('success', '已加载DRG分组规则模板');
            } else if (type === 'chronic') {
                document.getElementById('ruleName').value = '高血压慢病管理';
                document.getElementById('ruleDesc').value = '高血压患者的慢病审核和用药管理规则';
                showToast('success', '已加载慢病管理模板');
            }
        }

        // 工具函数
        function showLoader() {
            document.getElementById('loader').classList.add('active');
        }

        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('.toast-icon');
            const msg = toast.querySelector('.toast-message');

            // 设置类型
            toast.className = 'toast active ' + type;

            // 设置图标
            const icons = {
                success: '成功',
                error: '失败',
                warning: '警告',
                info: '信息'
            };
            icon.textContent = icons[type] || '信息';

            // 设置消息
            msg.textContent = message;

            // 自动隐藏
            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        function hideToast() {
            document.getElementById('toast').classList.remove('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // 搜索功能
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function (e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#rulesTableBody tr');

                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        });

        // 批量操作 - 移除重复的事件监听器绑定
        function initBatchCheckbox() {
            const selectAllCheckbox = document.querySelector('.data-table th .table-checkbox input');
            if (selectAllCheckbox) {
                // 先移除旧的事件监听器
                const newCheckbox = selectAllCheckbox.cloneNode(true);
                selectAllCheckbox.parentNode.replaceChild(newCheckbox, selectAllCheckbox);

                // 添加新的事件监听器
                newCheckbox.addEventListener('change', function (e) {
                    const checkboxes = document.querySelectorAll('#rulesTableBody .table-checkbox input');
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                });
            }
        }

        // 筛选功能
        document.querySelectorAll('.filter-select').forEach(select => {
            select.addEventListener('change', function () {
                filterRules();
            });
        });

        function filterRules() {
            // 实现筛选逻辑
            showToast('info', '正在应用筛选条件...');
            setTimeout(() => {
                loadRulesTable();
            }, 500);
        }



        // 键盘快捷键
        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + S 保存
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (currentPage === 'builder') {
                    saveAsDraft();
                } else if (currentPage === 'workflow') {
                    saveWorkflow();
                }
            }

            // Ctrl/Cmd + N 新建
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                createNewRule();
            }

            // ESC 关闭模态框
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });

        // 实时验证
        document.addEventListener('DOMContentLoaded', function () {
            const ruleNameInput = document.getElementById('ruleName');
            if (ruleNameInput) {
                ruleNameInput.addEventListener('blur', function () {
                    if (!this.value) {
                        this.style.borderColor = '#f56565';
                        showToast('error', '规则名称不能为空');
                    } else {
                        this.style.borderColor = '#e2e8f0';
                    }
                });
            }
        });

        // 自动保存
        let autoSaveTimer = null;
        function enableAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (currentPage === 'builder' || currentPage === 'workflow') {
                    // 模拟自动保存
                    console.log('自动保存中...');
                    showToast('info', '已自动保存');
                }
            }, 60000); // 每分钟自动保存
        }

        // 页面离开提醒
        window.addEventListener('beforeunload', function (e) {
            if (currentPage === 'builder' || currentPage === 'workflow') {
                const confirmationMessage = '您有未保存的更改，确定要离开吗？';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        // 响应式调整
        function adjustLayout() {
            const width = window.innerWidth;
            if (width < 768) {
                // 移动端调整
                document.querySelector('.dashboard-layout')?.classList.add('mobile');
            } else {
                document.querySelector('.dashboard-layout')?.classList.remove('mobile');
            }
        }

        window.addEventListener('resize', adjustLayout);
        adjustLayout();

        // 通知中心
        document.addEventListener('DOMContentLoaded', function () {
            const notificationBtn = document.querySelector('.notification-btn');
            if (notificationBtn) {
                notificationBtn.addEventListener('click', function () {
                    showToast('info', '您有3条未读通知');
                });
            }
        });

        // 用户菜单
        document.querySelector('.user-avatar')?.addEventListener('click', function () {
            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            menu.style.cssText = `
                position: absolute;
                top: 60px;
                right: 20px;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 8px 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                z-index: 1000;
            `;
            menu.innerHTML = `
                <div style="padding: 8px 16px; cursor: pointer; hover: background: #f7fafc;">个人信息</div>
                <div style="padding: 8px 16px; cursor: pointer;">系统设置</div>
                <div style="padding: 8px 16px; cursor: pointer;">操作日志</div>
                <hr style="margin: 8px 0; border: none; border-top: 1px solid #e2e8f0;">
                <div style="padding: 8px 16px; cursor: pointer; color: #f56565;">退出登录</div>
            `;

            document.body.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', function removeMenu() {
                    menu.remove();
                    document.removeEventListener('click', removeMenu);
                });
            }, 100);
        });

        // 分页功能
        document.querySelectorAll('.page-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                if (!this.disabled) {
                    document.querySelectorAll('.page-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    showLoader();
                    setTimeout(() => {
                        loadRulesTable();
                        hideLoader();
                    }, 300);
                }
            });
        });

        // 报告生成
        document.querySelector('.report-filters .btn-primary')?.addEventListener('click', function () {
            showLoader();
            setTimeout(() => {
                hideLoader();
                showToast('success', '报告生成完成');

                // 更新图表数据
                updateCharts();
            }, 1500);
        });

        function updateCharts() {
            // 模拟更新图表
            const bars = document.querySelectorAll('.chart-bar');
            bars.forEach(bar => {
                const height = Math.random() * 80 + 20;
                bar.style.height = height + '%';
                const value = Math.floor(Math.random() * 10000 + 1000);
                bar.querySelector('.chart-bar-value').textContent = value.toLocaleString();
            });
        }

        // 高级搜索
        function advancedSearch() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">高级搜索</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">规则名称</label>
                            <input type="text" class="form-input" placeholder="支持模糊搜索">
                        </div>
                        <div class="form-group">
                            <label class="form-label">创建时间</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" class="form-input">
                                <span style="align-self: center;">至</span>
                                <input type="date" class="form-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">创建人</label>
                            <select class="form-select">
                                <option>全部</option>
                                <option>张医生</option>
                                <option>李主任</option>
                                <option>王专员</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">规则内容</label>
                            <input type="text" class="form-input" placeholder="搜索规则内的字段或值">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">取消</button>
                        <button class="btn btn-primary" onclick="performAdvancedSearch()">搜索</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function performAdvancedSearch() {
            const m = document.querySelector('.modal'); if (m) m.classList.remove('active');
            showLoader();
            setTimeout(() => {
                hideLoader();
                showToast('success', '搜索完成，找到15条结果');
                loadRulesTable();
            }, 1000);
        }

        // 规则版本管理
        function showVersionHistory(ruleId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">版本历史</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>版本</th>
                                    <th>修改时间</th>
                                    <th>修改人</th>
                                    <th>变更说明</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>v2.3</td>
                                    <td>2024-03-15 14:30</td>
                                    <td>张医生</td>
                                    <td>修改了年龄条件</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary">查看</button>
                                        <button class="btn btn-sm btn-secondary">回滚</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>v2.2</td>
                                    <td>2024-03-10 10:15</td>
                                    <td>李主任</td>
                                    <td>添加了新的动作</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary">查看</button>
                                        <button class="btn btn-sm btn-secondary">回滚</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>v2.1</td>
                                    <td>2024-03-05 16:20</td>
                                    <td>王专员</td>
                                    <td>优化了规则逻辑</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary">查看</button>
                                        <button class="btn btn-sm btn-secondary">回滚</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 规则比较
        function compareRules() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1200px;">
                    <div class="modal-header">
                        <h2 class="modal-title">规则对比</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3 style="margin-bottom: 10px;">版本 v2.2</h3>
                                <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                                    <p><strong>条件：</strong></p>
                                    <p>患者年龄 &lt; 18</p>
                                    <p>药品名称 = "阿司匹林"</p>
                                    <p style="background: #fed7d7; padding: 4px; margin: 8px 0;">剂量 &gt; 100mg</p>
                                </div>
                            </div>
                            <div>
                                <h3 style="margin-bottom: 10px;">版本 v2.3</h3>
                                <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                                    <p><strong>条件：</strong></p>
                                    <p>患者年龄 &lt; 18</p>
                                    <p>药品名称 = "阿司匹林"</p>
                                    <p style="background: #c6f6d5; padding: 4px; margin: 8px 0;">剂量 &gt; 50mg</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 规则依赖关系
        function showRuleDependencies() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">规则依赖关系</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 40px;">
                            <svg width="400" height="300">
                                <circle cx="200" cy="50" r="30" fill="#667eea" />
                                <text x="200" y="55" text-anchor="middle" fill="white" font-size="12">主规则</text>
                                
                                <circle cx="100" cy="150" r="25" fill="#48bb78" />
                                <text x="100" y="155" text-anchor="middle" fill="white" font-size="11">子规则1</text>
                                
                                <circle cx="200" cy="150" r="25" fill="#48bb78" />
                                <text x="200" y="155" text-anchor="middle" fill="white" font-size="11">子规则2</text>
                                
                                <circle cx="300" cy="150" r="25" fill="#48bb78" />
                                <text x="300" y="155" text-anchor="middle" fill="white" font-size="11">子规则3</text>
                                
                                <circle cx="150" cy="250" r="20" fill="#ed8936" />
                                <text x="150" y="255" text-anchor="middle" fill="white" font-size="10">动作1</text>
                                
                                <circle cx="250" cy="250" r="20" fill="#ed8936" />
                                <text x="250" y="255" text-anchor="middle" fill="white" font-size="10">动作2</text>
                                
                                <line x1="200" y1="80" x2="100" y2="125" stroke="#cbd5e0" stroke-width="2" />
                                <line x1="200" y1="80" x2="200" y2="125" stroke="#cbd5e0" stroke-width="2" />
                                <line x1="200" y1="80" x2="300" y2="125" stroke="#cbd5e0" stroke-width="2" />
                                <line x1="125" y1="170" x2="150" y2="230" stroke="#cbd5e0" stroke-width="2" />
                                <line x1="225" y1="170" x2="250" y2="230" stroke="#cbd5e0" stroke-width="2" />
                            </svg>
                        </div>
                        <div style="margin-top: 20px;">
                            <p style="font-size: 14px; color: #718096;">
                                <strong>说明：</strong>该规则包含3个子规则和2个执行动作。子规则将按顺序执行，任一子规则触发都会执行相应的动作。
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 规则模拟运行
        function simulateRule() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2 class="modal-title">规则模拟运行</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3 style="margin-bottom: 10px;">输入数据</h3>
                                <div class="form-group">
                                    <label class="form-label">患者年龄</label>
                                    <input type="number" class="form-input" value="15">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">药品名称</label>
                                    <input type="text" class="form-input" value="阿司匹林">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">剂量(mg)</label>
                                    <input type="number" class="form-input" value="100">
                                </div>
                                <button class="btn btn-primary" onclick="runSimulation()">运行模拟</button>
                            </div>
                            <div>
                                <h3 style="margin-bottom: 10px;">执行结果</h3>
                                <div id="simulationResult" style="background: #1a202c; color: #68d391; padding: 15px; border-radius: 8px; min-height: 200px; font-family: monospace; font-size: 13px;">
                                    等待运行...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function runSimulation() {
            const result = document.getElementById('simulationResult');
            result.innerHTML = `
                <div>正在执行规则...</div>
                <div style="margin-top: 10px;">[√] 条件1: 患者年龄(15) < 18 - 满足</div>
                <div>[√] 条件2: 药品名称(阿司匹林) = 阿司匹林 - 满足</div>
                <div>[√] 条件3: 剂量(100) > 50 - 满足</div>
                <div style="margin-top: 10px; color: #f6e05e;">! 触发动作: 标记人工复核</div>
                <div style="margin-top: 10px; color: #68d391;">[√] 模拟运行完成</div>
            `;
        }

        // 批量规则操作
        function batchOperation() {
            const checkedBoxes = document.querySelectorAll('#rulesTableBody .table-checkbox input:checked');
            if (checkedBoxes.length === 0) {
                showToast('warning', '请先选择要操作的规则');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">批量操作</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 20px;">已选择 ${checkedBoxes.length} 条规则</p>
                        <div class="form-group">
                            <label class="form-label">选择操作</label>
                            <select class="form-select" id="batchAction">
                                <option value="">请选择</option>
                                <option value="activate">批量激活</option>
                                <option value="deactivate">批量停用</option>
                                <option value="archive">批量归档</option>
                                <option value="delete">批量删除</option>
                                <option value="export">批量导出</option>
                                <option value="tag">批量打标签</option>
                            </select>
                        </div>
                        <div id="batchOptions"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">取消</button>
                        <button class="btn btn-primary" onclick="executeBatchOperation()">执行</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('batchAction').addEventListener('change', function () {
                const options = document.getElementById('batchOptions');
                if (this.value === 'tag') {
                    options.innerHTML = `
                        <div class="form-group">
                            <label class="form-label">选择标签</label>
                            <div class="form-checkbox-group" style="flex-direction: column;">
                                <label class="form-checkbox-item">
                                    <input type="checkbox" value="urgent">
                                    <span>紧急</span>
                                </label>
                                <label class="form-checkbox-item">
                                    <input type="checkbox" value="review">
                                    <span>需复核</span>
                                </label>
                                <label class="form-checkbox-item">
                                    <input type="checkbox" value="2024">
                                    <span>2024新规</span>
                                </label>
                            </div>
                        </div>
                    `;
                } else {
                    options.innerHTML = '';
                }
            });
        }

        function executeBatchOperation() {
            const action = document.getElementById('batchAction').value;
            if (!action) {
                showToast('error', '请选择操作类型');
                return;
            }

            const m = document.querySelector('.modal'); if (m) m.classList.remove('active');
            showLoader();

            setTimeout(() => {
                hideLoader();
                showToast('success', `批量操作执行成功`);
                loadRulesTable();
            }, 1500);
        }

        // 规则性能监控
        function showPerformanceMonitor() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2 class="modal-title">规则性能监控</h2>
                        <button class="modal-close" onclick="this.closest('.modal').classList.remove('active')">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-value">12.3ms</div>
                                <div class="stat-label">平均响应时间</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">99.98%</div>
                                <div class="stat-label">可用性</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">1,234/s</div>
                                <div class="stat-label">吞吐量</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">0.02%</div>
                                <div class="stat-label">错误率</div>
                            </div>
                        </div>
                        <div style="background: #f7fafc; padding: 20px; border-radius: 8px;">
                            <h4 style="margin-bottom: 15px;">响应时间趋势（最近24小时）</h4>
                            <div style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around;">
                                ${Array(24).fill(0).map(() => {
                const height = Math.random() * 150 + 50;
                return `<div style="width: 20px; height: ${height}px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 2px;"></div>`;
            }).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').classList.remove('active')">关闭</button>
                        <button class="btn btn-primary">导出报告</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 启用自动保存
        enableAutoSave();

        // 初始化完成
        console.log('医保规则管理系统初始化完成');
    </script>

    <!-- 规则构建器页面 -->
    <div id="builder" class="page">
        <!-- 顶部导航栏 -->
        <div class="builder-nav">
            <div class="builder-breadcrumb">
                <span>首页</span>
                <span class="separator">›</span>
                <span>规则库</span>
                <span class="separator">›</span>
                <span style="color: #2d3748; font-weight: 500;">规则构建器</span>
            </div>
            <div class="builder-actions">
                <button class="btn btn-outline" onclick="previewRule()">
                    <i class="icon-eye"></i> 预览
                </button>
                <button class="btn btn-outline" onclick="saveAsDraft()">
                    <i class="icon-save"></i> 保存草稿
                </button>
                <button class="btn btn-primary" onclick="saveAndActivateWithValidation()">
                    <i class="icon-check"></i> 保存并激活
                </button>
            </div>
        </div>

        <div class="rule-builder-container">
            <!-- 左侧主要内容区 -->
            <div class="rule-main">
                <!-- 进度指示器 -->
                <div class="progress-indicator">
                    <div class="progress-step active">
                        <div class="step-circle">1</div>
                        <span>基本信息</span>
                    </div>
                    <div class="progress-step">
                        <div class="step-circle">2</div>
                        <span>规则配置</span>
                    </div>
                    <div class="progress-step">
                        <div class="step-circle">3</div>
                        <span>测试验证</span>
                    </div>
                </div>

                <!-- 基本信息卡片 -->
                <div class="rule-card" id="basicInfoCard">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="icon-info-circle"></i>
                            基本信息
                        </h2>
                        <div class="card-subtitle">配置规则的基础属性和元数据</div>
                    </div>
                    <div class="card-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="field-label">
                                    <i class="icon-tag"></i>
                                    规则名称
                                    <span style="color: #e53e3e;">*</span>
                                </label>
                                <input type="text" class="form-input" id="ruleName" placeholder="请输入规则名称">
                                <div class="field-help">规则名称应简洁明了，便于识别和管理</div>
                            </div>

                            <div class="form-group">
                                <label class="field-label">
                                    <i class="icon-file-text"></i>
                                    规则描述
                                </label>
                                <textarea class="form-textarea" id="ruleDesc" rows="3" placeholder="请详细描述规则的目的、依据和适用场景"></textarea>
                                <div class="field-help">详细的描述有助于其他用户理解规则用途</div>
                            </div>

                            <div class="form-group full-width">
                                <label class="field-label">
                                    <i class="icon-settings"></i>
                                    规则类型
                                    <span style="color: #e53e3e;">*</span>
                                </label>
                                <div class="rule-type-selector">
                                    <div class="rule-type-grid">
                                        <div class="rule-type-option selected" data-type="condition" onclick="selectRuleType(this, 'condition')">
                                            <div class="rule-type-icon">IF</div>
                                            <div class="rule-type-name">条件规则</div>
                                            <div class="rule-type-desc">IF-THEN 逻辑判断</div>
                                        </div>
                                        <div class="rule-type-option" data-type="decision" onclick="selectRuleType(this, 'decision')">
                                            <div class="rule-type-icon">表</div>
                                            <div class="rule-type-name">决策表</div>
                                            <div class="rule-type-desc">表格化规则配置</div>
                                        </div>
                                        <div class="rule-type-option" data-type="workflow" onclick="selectRuleType(this, 'workflow')">
                                            <div class="rule-type-icon">流</div>
                                            <div class="rule-type-name">工作流</div>
                                            <div class="rule-type-desc">流程化业务逻辑</div>
                                        </div>
                                        <div class="rule-type-option" data-type="scoring" onclick="selectRuleType(this, 'scoring')">
                                            <div class="rule-type-icon">分</div>
                                            <div class="rule-type-name">评分规则</div>
                                            <div class="rule-type-desc">风险评分计算</div>
                                        </div>
                                        <div class="rule-type-option" data-type="threshold" onclick="selectRuleType(this, 'threshold')">
                                            <div class="rule-type-icon">阈</div>
                                            <div class="rule-type-name">阈值规则</div>
                                            <div class="rule-type-desc">指标阈值监控</div>
                                        </div>
                                        <div class="rule-type-option" data-type="frequency" onclick="selectRuleType(this, 'frequency')">
                                            <div class="rule-type-icon">频</div>
                                            <div class="rule-type-name">频次规则</div>
                                            <div class="rule-type-desc">频次统计分析</div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="ruleType" value="condition">
                                </div>
                                <div class="field-help">选择适合的规则类型来配置不同的业务逻辑</div>
                            </div>

                            <div class="form-group">
                                <label class="field-label">
                                    <i class="icon-target"></i>
                                    适用范围
                                </label>
                                <div class="scope-options">
                                    <div class="scope-option" data-scope="before">
                                        <div class="scope-icon">前</div>
                                        <div class="scope-content">
                                            <div class="scope-name">事前审核</div>
                                            <div class="scope-desc">处方开具前的预防性审核</div>
                                        </div>
                                        <input type="checkbox" name="scope" value="before">
                                    </div>
                                    <div class="scope-option" data-scope="during">
                                        <div class="scope-icon">中</div>
                                        <div class="scope-content">
                                            <div class="scope-name">事中审核</div>
                                            <div class="scope-desc">医疗过程中的实时监控</div>
                                        </div>
                                        <input type="checkbox" name="scope" value="during">
                                    </div>
                                    <div class="scope-option" data-scope="after">
                                        <div class="scope-icon">后</div>
                                        <div class="scope-content">
                                            <div class="scope-name">事后审核</div>
                                            <div class="scope-desc">医疗行为完成后的回顾性审核</div>
                                        </div>
                                        <input type="checkbox" name="scope" value="after">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label class="field-label">
                                    <i class="icon-hash"></i>
                                    标签
                                </label>
                                <div class="tag-input-wrapper">
                                    <div class="tag-input-container" id="tagContainer">
                                        <div class="tag-list" id="tagList"></div>
                                        <input type="text" class="tag-input" placeholder="输入标签后按回车添加"
                                            onkeypress="handleTagInput(event)">
                                    </div>
                                    <div class="tag-suggestions">
                                        <span class="tag-suggestion" onclick="addSuggestedTag('抗生素')">抗生素</span>
                                        <span class="tag-suggestion" onclick="addSuggestedTag('DRG')">DRG</span>
                                        <span class="tag-suggestion" onclick="addSuggestedTag('慢病')">慢病</span>
                                        <span class="tag-suggestion" onclick="addSuggestedTag('费用控制')">费用控制</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 条件规则配置 -->
                <div id="conditionRuleSection" style="display: none;">
                    <!-- IF 条件卡片 -->
                    <div class="rule-card" id="conditionCard">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-filter"></i>
                                IF 条件设置
                            </h2>
                            <div class="card-subtitle">定义触发规则的条件逻辑</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="addConditionGroup()">
                                    <i class="icon-plus"></i> 添加条件组
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="conditionsContainer">
                                <div class="condition-group-wrapper">
                                    <div class="condition-group" data-group-id="1">
                                        <div class="condition-group-header">
                                            <div class="logic-selector">
                                                <span class="logic-label">当满足</span>
                                                <div class="logic-toggle">
                                                    <button class="logic-btn active" data-logic="AND" onclick="toggleLogic(this, 'AND')">
                                                        <span class="logic-text">所有条件</span>
                                                        <span class="logic-code">AND</span>
                                                    </button>
                                                    <button class="logic-btn" data-logic="OR" onclick="toggleLogic(this, 'OR')">
                                                        <span class="logic-text">任一条件</span>
                                                        <span class="logic-code">OR</span>
                                                    </button>
                                                </div>
                                                <span class="logic-label">时：</span>
                                            </div>
                                            <div class="group-actions">
                                                <button class="btn btn-sm btn-ghost" onclick="addCondition(this)">
                                                    <i class="icon-plus"></i>
                                                </button>
                                                <button class="btn btn-sm btn-ghost" onclick="removeConditionGroup(this)">
                                                    <i class="icon-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="condition-list">
                                            <div class="condition-row">
                                                <div class="condition-field">
                                                    <label class="field-label">字段</label>
                                                    <select class="form-select field-select">
                                                        <option value="">请选择字段</option>
                                                        <optgroup label="患者信息">
                                                            <option value="patient_age">患者年龄</option>
                                                            <option value="patient_gender">患者性别</option>
                                                            <option value="insurance_type">参保类型</option>
                                                        </optgroup>
                                                        <optgroup label="诊断信息">
                                                            <option value="primary_diagnosis">主诊断编码</option>
                                                            <option value="secondary_diagnosis">次诊断编码</option>
                                                            <option value="diagnosis_name">诊断名称</option>
                                                        </optgroup>
                                                        <optgroup label="药品信息">
                                                            <option value="drug_name">药品名称</option>
                                                            <option value="drug_code">药品编码</option>
                                                            <option value="drug_dosage">药品剂量</option>
                                                            <option value="medication_days">用药天数</option>
                                                        </optgroup>
                                                        <optgroup label="费用信息">
                                                            <option value="total_cost">总费用</option>
                                                            <option value="self_pay">自费金额</option>
                                                            <option value="insurance_pay">医保支付金额</option>
                                                        </optgroup>
                                                    </select>
                                                </div>
                                                
                                                <div class="condition-operator">
                                                    <label class="field-label">操作符</label>
                                                    <select class="form-select operator-select">
                                                        <option value="eq">等于 (=)</option>
                                                        <option value="ne">不等于 (≠)</option>
                                                        <option value="gt">大于 (>)</option>
                                                        <option value="lt">小于 (<)</option>
                                                        <option value="gte">大于等于 (≥)</option>
                                                        <option value="lte">小于等于 (≤)</option>
                                                        <option value="contains">包含</option>
                                                        <option value="not_contains">不包含</option>
                                                        <option value="is_null">为空</option>
                                                        <option value="is_not_null">不为空</option>
                                                        <option value="in">在列表中</option>
                                                        <option value="not_in">不在列表中</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="condition-value">
                                                    <label class="field-label">值</label>
                                                    <input type="text" class="form-input value-input" placeholder="请输入条件值">
                                                </div>
                                                
                                                <div class="condition-actions">
                                                    <button class="btn btn-sm btn-ghost" onclick="removeCondition(this)" title="删除条件">
                                                        <i class="icon-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="condition-footer">
                                <button class="btn btn-outline" onclick="addCondition()">
                                    <i class="icon-plus"></i> 添加条件
                                </button>
                            </div>
                    </div>

                    <!-- THEN 动作卡片 -->
                    <div class="rule-card" id="actionCard">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-arrow-right"></i>
                                THEN 动作设置
                            </h2>
                            <div class="card-subtitle">定义满足条件时执行的动作</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="addAction()">
                                    <i class="icon-plus"></i> 添加动作
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="actionsContainer">
                                <div class="action-list">
                                    <div class="action-row">
                                        <div class="action-type">
                                            <label class="field-label">动作类型</label>
                                            <select class="form-select action-select">
                                                <option value="">请选择动作</option>
                                                <optgroup label="审核动作">
                                                    <option value="manual_review">标记人工复核</option>
                                                    <option value="reject_settlement">拒绝结算</option>
                                                    <option value="require_approval">需要审批</option>
                                                </optgroup>
                                                <optgroup label="通知动作">
                                                    <option value="send_notification">发送通知</option>
                                                    <option value="generate_warning">生成警告</option>
                                                    <option value="send_alert">发送告警</option>
                                                </optgroup>
                                                <optgroup label="记录动作">
                                                    <option value="log_record">记录日志</option>
                                                    <option value="create_report">生成报告</option>
                                                    <option value="update_status">更新状态</option>
                                                </optgroup>
                                                <optgroup label="费用动作">
                                                    <option value="adjust_payment">调整支付比例</option>
                                                    <option value="apply_discount">应用折扣</option>
                                                    <option value="block_payment">阻止支付</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        
                                        <div class="action-params">
                                            <label class="field-label">动作参数</label>
                                            <input type="text" class="form-input param-input" placeholder="请输入动作参数（如复核原因、通知内容等）">
                                        </div>
                                        
                                        <div class="action-priority">
                                            <label class="field-label">优先级</label>
                                            <select class="form-select priority-select">
                                                <option value="low">低</option>
                                                <option value="medium" selected>中</option>
                                                <option value="high">高</option>
                                                <option value="urgent">紧急</option>
                                            </select>
                                        </div>
                                        
                                        <div class="action-actions">
                                            <button class="btn btn-sm btn-ghost" onclick="removeAction(this)" title="删除动作">
                                                <i class="icon-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-footer">
                                <button class="btn btn-outline" onclick="addAction()">
                                    <i class="icon-plus"></i> 添加动作
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 决策表配置 -->
                <div id="decisionTableSection" style="display: none;">
                    <div class="rule-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-table"></i>
                                决策表配置
                            </h2>
                            <div class="card-subtitle">通过表格形式定义多种条件组合及对应动作</div>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline" onclick="addDecisionColumn()">
                                    <i class="icon-plus"></i> 添加条件列
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="addDecisionRow()">
                                    <i class="icon-plus"></i> 添加规则行
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="decision-table-wrapper">
                                <div class="table-container">
                                    <table class="decision-table">
                                        <thead>
                                            <tr class="table-header">
                                                <th class="condition-header">
                                                    <div class="header-content">
                                                        <span class="header-title">诊断编码</span>
                                                        <div class="header-actions">
                                                            <button class="btn btn-xs btn-ghost" onclick="editColumn(this)" title="编辑列">
                                                                <i class="icon-edit"></i>
                                                            </button>
                                                            <button class="btn btn-xs btn-ghost" onclick="removeColumn(this)" title="删除列">
                                                                <i class="icon-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="header-type">文本型</div>
                                                </th>
                                                <th class="condition-header">
                                                    <div class="header-content">
                                                        <span class="header-title">手术编码</span>
                                                        <div class="header-actions">
                                                            <button class="btn btn-xs btn-ghost" onclick="editColumn(this)" title="编辑列">
                                                                <i class="icon-edit"></i>
                                                            </button>
                                                            <button class="btn btn-xs btn-ghost" onclick="removeColumn(this)" title="删除列">
                                                                <i class="icon-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="header-type">文本型</div>
                                                </th>
                                                <th class="condition-header">
                                                    <div class="header-content">
                                                        <span class="header-title">年龄范围</span>
                                                        <div class="header-actions">
                                                            <button class="btn btn-xs btn-ghost" onclick="editColumn(this)" title="编辑列">
                                                                <i class="icon-edit"></i>
                                                            </button>
                                                            <button class="btn btn-xs btn-ghost" onclick="removeColumn(this)" title="删除列">
                                                                <i class="icon-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="header-type">范围型</div>
                                                </th>
                                                <th class="condition-header">
                                                    <div class="header-content">
                                                        <span class="header-title">住院天数</span>
                                                        <div class="header-actions">
                                                            <button class="btn btn-xs btn-ghost" onclick="editColumn(this)" title="编辑列">
                                                                <i class="icon-edit"></i>
                                                            </button>
                                                            <button class="btn btn-xs btn-ghost" onclick="removeColumn(this)" title="删除列">
                                                                <i class="icon-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="header-type">范围型</div>
                                                </th>
                                                <th class="action-header">
                                                    <div class="header-content">
                                                        <span class="header-title">DRG分组</span>
                                                    </div>
                                                </th>
                                                <th class="action-header">
                                                    <div class="header-content">
                                                        <span class="header-title">支付标准</span>
                                                    </div>
                                                </th>
                                                <th class="operation-header">
                                                    <div class="header-content">
                                                        <span class="header-title">操作</span>
                                                    </div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class="table-body">
                                            <tr class="decision-row">
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="I10" placeholder="诊断编码">
                                                </td>
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="-" placeholder="手术编码">
                                                </td>
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="18-65" placeholder="年龄范围">
                                                </td>
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="1-7" placeholder="住院天数">
                                                </td>
                                                <td class="action-cell">
                                                    <input type="text" class="form-input action-value" value="FV15" placeholder="DRG分组">
                                                </td>
                                                <td class="action-cell">
                                                    <input type="number" class="form-input action-value" value="3500" placeholder="支付标准">
                                                </td>
                                                <td class="operation-cell">
                                                    <div class="row-actions">
                                                        <button class="btn btn-xs btn-ghost" onclick="duplicateRow(this)" title="复制行">
                                                            <i class="icon-copy"></i>
                                                        </button>
                                                        <button class="btn btn-xs btn-ghost" onclick="removeRow(this)" title="删除行">
                                                            <i class="icon-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="decision-row">
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="I10" placeholder="诊断编码">
                                                </td>
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="-" placeholder="手术编码">
                                                </td>
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value=">65" placeholder="年龄范围">
                                                </td>
                                                <td class="condition-cell">
                                                    <input type="text" class="form-input condition-value" value="1-7" placeholder="住院天数">
                                                </td>
                                                <td class="action-cell">
                                                    <input type="text" class="form-input action-value" value="FV16" placeholder="DRG分组">
                                                </td>
                                                <td class="action-cell">
                                                    <input type="number" class="form-input action-value" value="4200" placeholder="支付标准">
                                                </td>
                                                <td class="operation-cell">
                                                    <div class="row-actions">
                                                        <button class="btn btn-xs btn-ghost" onclick="duplicateRow(this)" title="复制行">
                                                            <i class="icon-copy"></i>
                                                        </button>
                                                        <button class="btn btn-xs btn-ghost" onclick="removeRow(this)" title="删除行">
                                                            <i class="icon-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="table-footer">
                                    <div class="table-stats">
                                        <span class="stats-item">共 <strong>2</strong> 条规则</span>
                                        <span class="stats-item">覆盖 <strong>4</strong> 个条件</span>
                                    </div>
                                    <div class="table-actions">
                                        <button class="btn btn-outline" onclick="addDecisionRow()">
                                            <i class="icon-plus"></i> 添加规则行
                                        </button>
                                        <button class="btn btn-outline" onclick="validateTable()">
                                            <i class="icon-check"></i> 验证表格
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 工作流规则配置区域 -->
                <div id="workflowRuleSection" style="display: none;">
                    <div class="rule-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-workflow"></i>
                                工作流配置
                            </h2>
                            <div class="card-subtitle">通过流程图定义复杂的业务流程和审批逻辑</div>
                        </div>
                        <div class="card-content">
                            <div class="workflow-canvas">
                                <div class="workflow-node start-node" data-node-type="start">
                                    <div class="node-icon">
                                        <i class="icon-play"></i>
                                    </div>
                                    <div class="node-label">开始</div>
                                </div>
                                <div class="workflow-toolbar">
                                    <button class="btn btn-sm btn-outline" onclick="addWorkflowNode('condition')">
                                        <i class="icon-diamond"></i> 条件节点
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="addWorkflowNode('action')">
                                        <i class="icon-square"></i> 动作节点
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="addWorkflowNode('approval')">
                                        <i class="icon-user"></i> 审批节点
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 评分规则配置区域 -->
                <div id="scoringRuleSection" style="display: none;">
                    <div class="rule-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-star"></i>
                                评分规则配置
                            </h2>
                            <div class="card-subtitle">基于多个因子进行加权评分，支持线性和非线性评分模型</div>
                        </div>
                        <div class="card-content">
                            <div class="scoring-config">
                                <div class="config-section">
                                    <h3 class="section-title">评分模型</h3>
                                    <div class="form-group">
                                        <label class="form-label">评分方式</label>
                                        <select class="form-select" id="scoringMethod">
                                            <option value="weighted">加权评分</option>
                                            <option value="linear">线性评分</option>
                                            <option value="exponential">指数评分</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">评分因子</h3>
                                    <div class="scoring-factors">
                                        <div class="factor-item">
                                            <div class="factor-info">
                                                <label class="form-label">患者年龄</label>
                                                <input type="number" class="form-input" placeholder="权重" value="20">
                                            </div>
                                            <div class="factor-actions">
                                                <button class="btn btn-xs btn-ghost" onclick="removeFactor(this)">
                                                    <i class="icon-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="factor-item">
                                            <div class="factor-info">
                                                <label class="form-label">费用金额</label>
                                                <input type="number" class="form-input" placeholder="权重" value="30">
                                            </div>
                                            <div class="factor-actions">
                                                <button class="btn btn-xs btn-ghost" onclick="removeFactor(this)">
                                                    <i class="icon-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline" onclick="addScoringFactor()">
                                        <i class="icon-plus"></i> 添加因子
                                    </button>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">风险阈值</h3>
                                    <div class="threshold-config">
                                        <div class="form-group">
                                            <label class="form-label">低风险阈值</label>
                                            <input type="number" class="form-input" value="30" placeholder="分数">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">中风险阈值</label>
                                            <input type="number" class="form-input" value="60" placeholder="分数">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">高风险阈值</label>
                                            <input type="number" class="form-input" value="80" placeholder="分数">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 阈值规则配置区域 -->
                <div id="thresholdRuleSection" style="display: none;">
                    <div class="rule-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-gauge"></i>
                                阈值规则配置
                            </h2>
                            <div class="card-subtitle">设置监控指标的阈值范围，超出时触发相应动作</div>
                        </div>
                        <div class="card-content">
                            <div class="threshold-config">
                                <div class="config-section">
                                    <h3 class="section-title">监控指标</h3>
                                    <div class="form-group">
                                        <label class="form-label">指标类型</label>
                                        <select class="form-select" id="thresholdIndicator">
                                            <option value="single_cost">单次费用</option>
                                            <option value="hospital_days">住院天数</option>
                                            <option value="drug_cost_ratio">药品费用占比</option>
                                            <option value="exam_cost">检查费用</option>
                                            <option value="surgery_cost">手术费用</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">阈值设置</h3>
                                    <div class="form-group">
                                        <label class="form-label">阈值类型</label>
                                        <select class="form-select" id="thresholdType">
                                            <option value="single">单一阈值</option>
                                            <option value="range">范围阈值</option>
                                            <option value="percentage">百分比阈值</option>
                                        </select>
                                    </div>
                                    <div class="threshold-values">
                                        <div class="form-group">
                                            <label class="form-label">阈值</label>
                                            <input type="number" class="form-input" placeholder="输入阈值" value="5000">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">触发条件</h3>
                                    <div class="form-group">
                                        <label class="form-label">触发方式</label>
                                        <select class="form-select" id="triggerCondition">
                                            <option value="greater">大于阈值</option>
                                            <option value="less">小于阈值</option>
                                            <option value="equal">等于阈值</option>
                                            <option value="between">在范围内</option>
                                            <option value="outside">在范围外</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">触发动作</h3>
                                    <div class="form-group">
                                        <label class="form-label">动作类型</label>
                                        <select class="form-select" id="triggerAction">
                                            <option value="manual_review">人工审核</option>
                                            <option value="auto_reject">自动拒付</option>
                                            <option value="warning">预警提示</option>
                                            <option value="reduce_payment">降低支付比例</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 频次规则配置区域 -->
                <div id="frequencyRuleSection" style="display: none;">
                    <div class="rule-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="icon-clock"></i>
                                频次规则配置
                            </h2>
                            <div class="card-subtitle">监控特定时间窗口内的行为频次，防止过度医疗</div>
                        </div>
                        <div class="card-content">
                            <div class="frequency-config">
                                <div class="config-section">
                                    <h3 class="section-title">监控对象</h3>
                                    <div class="form-group">
                                        <label class="form-label">监控维度</label>
                                        <select class="form-select" id="monitoringObject">
                                            <option value="patient">患者</option>
                                            <option value="doctor">医生</option>
                                            <option value="department">科室</option>
                                            <option value="drug">药品</option>
                                            <option value="diagnosis">诊断</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">监控行为</h3>
                                    <div class="form-group">
                                        <label class="form-label">行为类型</label>
                                        <select class="form-select" id="monitoringAction">
                                            <option value="visit_count">就诊次数</option>
                                            <option value="prescription_count">开药次数</option>
                                            <option value="exam_count">检查次数</option>
                                            <option value="hospitalization_count">住院次数</option>
                                            <option value="surgery_count">手术次数</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">时间窗口</h3>
                                    <div class="time-window">
                                        <div class="form-group">
                                            <label class="form-label">时间单位</label>
                                            <select class="form-select" id="timeUnit">
                                                <option value="days">天</option>
                                                <option value="weeks">周</option>
                                                <option value="months">月</option>
                                                <option value="years">年</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">时间长度</label>
                                            <input type="number" class="form-input" value="30" placeholder="时间长度">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">频次限制</h3>
                                    <div class="form-group">
                                        <label class="form-label">最大频次</label>
                                        <input type="number" class="form-input" value="5" placeholder="最大允许次数">
                                    </div>
                                </div>
                                
                                <div class="config-section">
                                    <h3 class="section-title">例外条件</h3>
                                    <div class="exception-conditions">
                                        <div class="condition-item">
                                            <input type="text" class="form-input" placeholder="例外条件描述" value="急诊情况">
                                            <button class="btn btn-xs btn-ghost" onclick="removeException(this)">
                                                <i class="icon-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline" onclick="addException()">
                                        <i class="icon-plus"></i> 添加例外
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作引导卡片 -->
                <div class="rule-card guidance-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="icon-info"></i>
                            操作指南
                        </h2>
                        <div class="card-subtitle">按照以下步骤完成规则配置</div>
                    </div>
                    <div class="card-content">
                        <div class="guidance-steps">
                            <div class="step-item">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">填写基本信息</div>
                                    <div class="step-desc">设置规则名称、描述、类型和适用范围</div>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">配置规则逻辑</div>
                                    <div class="step-desc">根据选择的规则类型配置条件和动作</div>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">测试验证</div>
                                    <div class="step-desc">使用测试功能验证规则逻辑的正确性</div>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <div class="step-title">保存激活</div>
                                    <div class="step-desc">保存为草稿或直接激活规则使其生效</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮区域 -->
                <div class="action-bar">
                    <div class="action-left">
                        <button class="btn btn-ghost" onclick="goBackToDashboard()">
                            <i class="icon-arrow-left"></i> 返回规则库
                        </button>
                        <button class="btn btn-ghost" onclick="clearForm()">
                            <i class="icon-refresh"></i> 清空表单
                        </button>
                    </div>
                    <div class="action-right">
                        <button class="btn btn-outline" onclick="testRuleWithValidation()">
                            <i class="icon-play"></i> 测试规则
                        </button>
                        <button class="btn btn-secondary" onclick="saveAsDraft()">
                            <i class="icon-save"></i> 保存草稿
                        </button>
                        <button class="btn btn-primary" onclick="saveAndActivateWithValidation()">
                            <i class="icon-check"></i> 保存并激活
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧辅助面板 -->
            <div class="rule-sidebar">
                <!-- 规则模板卡片 -->
                <div class="sidebar-card">
                    <div class="sidebar-card-header">
                        <h3 class="sidebar-card-title">
                            <i class="icon-template"></i>
                            规则模板
                        </h3>
                    </div>
                    <div class="sidebar-card-content">
                        <div class="template-list">
                            <div class="template-item" onclick="loadTemplate('drug')">
                                <div class="template-icon">药</div>
                                <div class="template-content">
                                    <div class="template-name">抗生素使用规范</div>
                                    <div class="template-desc">限制三代头孢使用</div>
                                </div>
                                <div class="template-action">
                                    <i class="icon-arrow-right"></i>
                                </div>
                            </div>
                            <div class="template-item" onclick="loadTemplate('drg')">
                                <div class="template-icon">表</div>
                                <div class="template-content">
                                    <div class="template-name">DRG分组规则</div>
                                    <div class="template-desc">心内科常见病种</div>
                                </div>
                                <div class="template-action">
                                    <i class="icon-arrow-right"></i>
                                </div>
                            </div>
                            <div class="template-item" onclick="loadTemplate('chronic')">
                                <div class="template-icon">病</div>
                                <div class="template-content">
                                    <div class="template-name">慢病管理</div>
                                    <div class="template-desc">高血压用药审核</div>
                                </div>
                                <div class="template-action">
                                    <i class="icon-arrow-right"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近使用字段卡片 -->
                <div class="sidebar-card">
                    <div class="sidebar-card-header">
                        <h3 class="sidebar-card-title">
                            <i class="icon-history"></i>
                            最近使用的字段
                        </h3>
                    </div>
                    <div class="sidebar-card-content">
                        <div class="field-list">
                            <div class="field-item" onclick="insertField('patient_age')">
                                <span class="field-name">患者年龄</span>
                                <span class="field-type">数值型</span>
                            </div>
                            <div class="field-item" onclick="insertField('drug_name')">
                                <span class="field-name">药品名称</span>
                                <span class="field-type">文本型</span>
                            </div>
                            <div class="field-item" onclick="insertField('diagnosis_code')">
                                <span class="field-name">诊断编码</span>
                                <span class="field-type">文本型</span>
                            </div>
                            <div class="field-item" onclick="insertField('total_cost')">
                                <span class="field-name">总费用</span>
                                <span class="field-type">数值型</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 帮助文档卡片 -->
                <div class="sidebar-card">
                    <div class="sidebar-card-header">
                        <h3 class="sidebar-card-title">
                            <i class="icon-help"></i>
                            帮助文档
                        </h3>
                    </div>
                    <div class="sidebar-card-content">
                        <div class="help-content">
                            <div class="help-item">
                                <div class="help-title">条件规则</div>
                                <div class="help-desc">适用于简单的判断逻辑，支持多条件组合。</div>
                            </div>
                            <div class="help-item">
                                <div class="help-title">决策表</div>
                                <div class="help-desc">适用于大量相似规则的批量管理，如DRG分组。</div>
                            </div>
                            <div class="help-item">
                                <div class="help-title">工作流规则</div>
                                <div class="help-desc">适用于复杂的业务流程控制和审批流程。</div>
                            </div>
                        </div>
                        <div class="help-actions">
                            <button class="btn btn-sm btn-outline" onclick="openHelpDoc()">
                                <i class="icon-external"></i> 查看完整文档
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 提示 -->
    <div id="toast" class="toast">
        <div class="toast-icon"></div>
        <div class="toast-message"></div>
    </div>

    <script>
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化页面
            initializePage();

            // 绑定事件监听器
            bindEventListeners();

            // 加载初始数据
            loadInitialData();
        });

        // 初始化页面
        function initializePage() {
            // 设置默认页面为规则管理
            showPage('dashboard');

            // 初始化图表
            initializeCharts();

            // 设置默认时间范围
            setDefaultDateRange();
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 导航菜单点击事件
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function () {
                    const page = this.dataset.page;
                    if (page) {
                        showPage(page);
                        updateActiveNav(this);
                    }
                });
            });

            // 搜索框事件
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(handleSearch, 300));
            }

            // 筛选器事件
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', handleFilter);
            });
        }

        // 加载初始数据
        function loadInitialData() {
            // 加载规则列表
            loadRuleList();

            // 加载统计数据
            loadStatistics();

            // 加载最近活动
            loadRecentActivities();
        }

        // 显示指定页面（与 navigateToPage 保持一致：仅通过 active 类切换显示，并清理内联样式）
        function showPage(pageId) {
            // 隐藏所有页面（移除 active 并清理可能残留的内联样式）
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = '';
            });

            // 显示指定页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = '';
            }

            // 更新页面标题
            updatePageTitle(pageId);
        }

        // 更新导航激活状态
        function updateActiveNav(activeItem) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            activeItem.classList.add('active');
        }

        // 更新页面标题
        function updatePageTitle(pageId) {
            const titles = {
                'dashboard': '规则库',
                'builder': '规则构建',
                'workflow': '工作流',
                'review': '审核中心',
                'test': '测试中心',
                'reports': '分析报告'
            };

            const title = titles[pageId] || '医保审核系统';
            document.title = title + ' - 医保审核系统';
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 搜索处理
        function handleSearch(event) {
            const query = event.target.value.trim();
            if (query.length >= 2) {
                performSearch(query);
            } else if (query.length === 0) {
                clearSearch();
            }
        }

        // 执行搜索
        function performSearch(query) {
            // 实现搜索逻辑
            console.log('搜索:', query);
            showToast('info', `搜索: ${query}`);
        }

        // 清除搜索
        function clearSearch() {
            // 重置搜索结果
            loadRuleList();
        }

        // 筛选处理
        function handleFilter(event) {
            const filterType = event.target.id;
            const filterValue = event.target.value;

            // 实现筛选逻辑
            console.log('筛选:', filterType, filterValue);
            applyFilters();
        }

        // 应用筛选器
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const typeFilter = document.getElementById('typeFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';

            // 实现筛选逻辑
            console.log('应用筛选器:', { statusFilter, typeFilter, categoryFilter });
        }

        // 加载规则列表（统一到 loadRulesTable）
        function loadRuleList() {
            // 直接调用统一的表格加载函数
            loadRulesTable();
        }

        // 渲染规则列表（统一到 loadRulesTable）
        function renderRuleList(rules) {
            // 此函数保留兼容性，实际使用 loadRulesTable
            loadRulesTable();
        }

        // 获取类型标签
        function getTypeLabel(type) {
            const labels = {
                'condition': '条件规则',
                'decision': '决策表',
                'workflow': '工作流'
            };
            return labels[type] || type;
        }

        // 获取分类标签
        function getCategoryLabel(category) {
            const labels = {
                'drug': '药品',
                'drg': 'DRG',
                'treatment': '诊疗',
                'policy': '政策'
            };
            return labels[category] || category;
        }

        // 获取状态标签
        function getStatusLabel(status) {
            const labels = {
                'active': '启用',
                'inactive': '停用',
                'draft': '草稿'
            };
            return labels[status] || status;
        }

        // 加载统计数据
        function loadStatistics() {
            // 模拟统计数据
            const stats = {
                totalRules: 156,
                activeRules: 142,
                todayExecutions: 2847,
                hitRate: '23.4%'
            };

            updateStatistics(stats);
        }

        // 更新统计数据
        function updateStatistics(stats) {
            const elements = {
                'totalRules': stats.totalRules,
                'activeRules': stats.activeRules,
                'todayExecutions': stats.todayExecutions,
                'hitRate': stats.hitRate
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        // 加载最近活动
        function loadRecentActivities() {
            // 模拟最近活动数据
            const activities = [
                { time: '10:30', action: '规则执行', description: '抗生素使用限制规则触发' },
                { time: '10:25', action: '规则修改', description: '更新DRG分组规则参数' },
                { time: '10:20', action: '审核完成', description: '患者张三的用药审核通过' }
            ];

            renderRecentActivities(activities);
        }

        // 渲染最近活动
        function renderRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            if (!container) return;

            container.innerHTML = activities.map(activity => `
        <div class="activity-item">
            <div class="activity-time">${activity.time}</div>
            <div class="activity-content">
                <div class="activity-action">${activity.action}</div>
                <div class="activity-description">${activity.description}</div>
            </div>
        </div>
    `).join('');
        }

        // 初始化图表
        function initializeCharts() {
            // 初始化规则执行趋势图
            initRuleTrendChart();

            // 初始化命中率分布图
            initHitRateChart();
        }

        // 初始化规则趋势图
        function initRuleTrendChart() {
            // 模拟图表初始化
            console.log('初始化规则趋势图');
        }

        // 初始化命中率图表
        function initHitRateChart() {
            // 模拟图表初始化
            console.log('初始化命中率图表');
        }

        // 设置默认时间范围
        function setDefaultDateRange() {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            if (startDateInput) {
                startDateInput.value = lastWeek.toISOString().split('T')[0];
            }

            if (endDateInput) {
                endDateInput.value = today.toISOString().split('T')[0];
            }
        }

        // 规则管理相关函数
        function addRule() {
            // 清除编辑状态
            document.body.removeAttribute('data-edit-index');
            // 导航到规则构建器页面
            navigateToPage('builder');
            // 清空表单
            setTimeout(() => {
                const ruleNameInput = document.getElementById('ruleName');
                const ruleDescInput = document.getElementById('ruleDesc');
                const typeSelect = document.getElementById('ruleType');
                if (ruleNameInput) ruleNameInput.value = '';
                if (ruleDescInput) ruleDescInput.value = '';
                if (typeSelect) {
                    const chosenType = selectedRuleType || typeSelect.value || 'condition';
                    typeSelect.value = chosenType;
                    switchRuleType(chosenType); // 按所选类型切换界面
                }
                showToast('info', '开始创建新规则');
            }, 200);
        }

        // 编辑规则函数（移除重复定义，保持统一）
        function editRule(index) {
            if (index === undefined || !rulesData[index]) {
                showToast('error', '无法找到指定的规则');
                return;
            }
            const rule = rulesData[index];
            navigateToPage('builder');
            
            setTimeout(() => {
                const ruleNameInput = document.getElementById('ruleName');
                const ruleDescInput = document.getElementById('ruleDesc');
                const typeSelect = document.getElementById('ruleType');
                
                if (ruleNameInput) ruleNameInput.value = rule.name || '';
                if (ruleDescInput) ruleDescInput.value = rule.desc || '这是' + rule.name + '的详细描述';
                
                // 根据规则类型设置选择器并切换界面
                if (typeSelect) {
                    let ruleTypeValue = 'condition';
                    if (rule.type === '决策表') ruleTypeValue = 'decision';
                    else if (rule.type === '工作流') ruleTypeValue = 'workflow';
                    else if (rule.type === '评分规则') ruleTypeValue = 'scoring';
                    else if (rule.type === '阈值规则') ruleTypeValue = 'threshold';
                    else if (rule.type === '频次规则') ruleTypeValue = 'frequency';
                    
                    typeSelect.value = ruleTypeValue;
                    switchRuleType(ruleTypeValue); // 切换到对应的规则界面
                }
                
                // 设置编辑状态
                document.body.dataset.editIndex = index;
                showToast('info', '正在编辑: ' + rule.name);
            }, 200);
        }

        function copyRule(index) {
            if (index === undefined || !rulesData[index]) {
                showToast('error', '无法找到指定的规则');
                return;
            }
            const src = rulesData[index];
            const copy = {
                ...src,
                id: nextRuleId++,
                name: src.name + ' - 副本',
                status: 'draft',
                triggers: '0',
                modifier: '当前用户',
                modifyTime: new Date().toLocaleString('zh-CN')
            };
            rulesData.unshift(copy);
            saveRulesToStorage();
            loadRulesTable();
            showToast('success', `规则 ${src.name} 已复制`);
        }

        function deleteRule(index) {
            if (index === undefined || !rulesData[index]) {
                showToast('error', '无法找到指定的规则');
                return;
            }
            if (!confirm('确定要删除这个规则吗？')) return;
            const removed = rulesData.splice(index, 1)[0];
            saveRulesToStorage();
            loadRulesTable();
            showToast('success', `规则 ${removed.name} 已删除`);
        }

        function toggleRuleStatus(index) {
            if (index === undefined || !rulesData[index]) {
                showToast('error', '无法找到指定的规则');
                return;
            }
            const rule = rulesData[index];
            rule.status = rule.status === 'active' ? 'draft' : 'active';
            rule.modifyTime = new Date().toLocaleString('zh-CN');
            rule.modifier = '当前用户';
            saveRulesToStorage();
            loadRulesTable();
            showToast('success', `规则 ${rule.name} 状态已更新为 ${rule.status === 'active' ? '已激活' : '草稿'}`);
        }

        function exportRules() {
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(rulesData, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute('href', dataStr);
            dl.setAttribute('download', 'rules.json');
            document.body.appendChild(dl);
            dl.click();
            dl.remove();
            showToast('success', '规则导出成功');
        }

        function importRules() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const imported = JSON.parse(reader.result);
                        if (!Array.isArray(imported)) throw new Error('文件格式不正确');
                        const maxId = rulesData.reduce((m, r) => Math.max(m, r.id || 0), 0);
                        nextRuleId = Math.max(nextRuleId, maxId + 1);
                        const normalized = imported.map(item => ({
                            id: item.id || nextRuleId++,
                            name: String(item.name || '未命名规则'),
                            type: ['条件规则','决策表','工作流'].includes(item.type) ? item.type : '条件规则',
                            status: ['active','draft','archived'].includes(item.status) ? item.status : 'draft',
                            triggers: String(item.triggers ?? '0'),
                            modifier: String(item.modifier || '导入'),
                            modifyTime: item.modifyTime || new Date().toLocaleString('zh-CN')
                        }));
                        rulesData = normalized;
                        saveRulesToStorage();
                        loadRulesTable();
                        showToast('success', '规则导入成功');
                    } catch (err) {
                        console.error(err);
                        showToast('error', '导入失败：' + err.message);
                    }
                };
                reader.readAsText(file, 'utf-8');
            };
            input.click();
        }

        // 工作流设计器相关函数
        function addWorkflowNode(nodeType) {
            console.log('添加工作流节点:', nodeType);
            showToast('success', `已添加${nodeType}节点`);
        }

        function saveWorkflow() {
            console.log('保存工作流');
            showToast('success', '工作流已保存');
        }

        function deployWorkflow() {
            console.log('部署工作流');
            showToast('success', '工作流已部署');
        }

        // 审核中心相关函数
        function viewPatientRecord(patientId) {
            console.log('查看患者记录:', patientId);
            showToast('info', `查看患者 ${patientId} 的记录`);
        }

        function submitAudit() {
            console.log('提交审核');
            showToast('success', '审核已提交');
        }

        function saveAsDraftSimple() {
            // 验证必填字段
            const ruleName = document.getElementById('ruleName')?.value?.trim();
            if (!ruleName) {
                showToast('warning', '请输入规则名称');
                return;
            }
            
            console.log('保存草稿');
            showToast('success', '规则已保存为草稿，您可以稍后继续编辑');
            
            // 3秒后提示后续操作
            setTimeout(() => {
                showToast('info', '提示：您可以在规则库中找到草稿规则并继续编辑');
            }, 3000);
        }

        // 测试中心相关函数
        function executeTest() {
            console.log('执行测试');
            showToast('info', '正在执行测试...');

            // 模拟测试执行
            setTimeout(() => {
                showToast('success', '测试执行完成');
            }, 2000);
        }

        function clearTestData() {
            console.log('清空测试数据');
            showToast('success', '测试数据已清空');
        }

        // 分析报告相关函数
        function generateReport() {
            console.log('生成报告');
            showToast('info', '正在生成报告...');

            // 模拟报告生成
            setTimeout(() => {
                showToast('success', '报告生成完成');
            }, 3000);
        }

        function exportExcel() {
            console.log('导出Excel');
            showToast('success', 'Excel文件已导出');
        }

        // 新建规则相关函数
        function selectRuleType(element, type) {
            // 清除其他选中状态
            element.parentElement.querySelectorAll('.rule-type-option').forEach(option => {
                option.classList.remove('selected');
            });

            // 设置选中状态
            element.classList.add('selected');
            
            // 更新隐藏字段
            const ruleTypeInput = document.getElementById('ruleType');
            if (ruleTypeInput) {
                ruleTypeInput.value = type;
            }
            
            // 切换规则配置区域
            switchRuleType(type);
            
            console.log('选择规则类型:', type);
        }

        function selectNewRuleType(element, type) {
            // 清除其他选中状态
            element.parentElement.querySelectorAll('div').forEach(div => {
                div.style.borderColor = '#e2e8f0';
                div.style.background = 'white';
            });

            // 设置选中状态
            element.style.borderColor = '#667eea';
            element.style.background = '#edf2ff';
            selectedRuleType = type;
            
            // 更新隐藏字段（如果存在）
            const ruleTypeInput = document.getElementById('ruleType');
            if (ruleTypeInput) {
                ruleTypeInput.value = type;
            }
            
            // 切换规则配置区域（如果在构建器页面）
            if (document.getElementById('conditionRuleSection')) {
                switchRuleType(type);
            }
            
            console.log('选择规则类型:', type);
        }

        function createRule() {
            // 检查是否有选中的规则类型（支持两种选择器）
            let selectedType = document.querySelector('.rule-type-option.selected');
            if (!selectedType) {
                selectedType = document.querySelector('.rule-type-card.selected');
            }
            
            // 如果还是没有找到，检查selectedRuleType变量
            if (!selectedType && !selectedRuleType) {
                showToast('warning', '请先选择规则类型');
                return;
            }
            
            const ruleType = selectedType ? selectedType.getAttribute('data-type') : selectedRuleType;
            console.log('创建规则，类型:', ruleType);
            
            // 跳转到构建器页面并设置规则类型
            navigateToPage('builder');
            
            // 延迟设置规则类型，确保页面已切换
            setTimeout(() => {
                if (ruleType) {
                    const ruleTypeInput = document.getElementById('ruleType');
                    if (ruleTypeInput) {
                        ruleTypeInput.value = ruleType;
                    }
                    switchRuleType(ruleType);
                    
                    // 更新规则类型选择器的视觉状态
                    const ruleTypeOptions = document.querySelectorAll('.rule-type-option');
                    ruleTypeOptions.forEach(option => {
                        option.classList.remove('selected');
                        if (option.getAttribute('data-type') === ruleType) {
                            option.classList.add('selected');
                        }
                    });
                }
            }, 100);
            
            showToast('success', '已进入规则构建器');
            closeModal('newRuleModal');
        }

        // 规则模板相关函数
        function loadTemplate(templateType) {
            console.log('加载模板:', templateType);
            showToast('success', `已加载${templateType}模板`);
        }

        // 模态框相关函数（统一实现）
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // 点击模态框背景关闭
        document.addEventListener('click', function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Toast提示相关函数已在前面定义
        
        // 新增的辅助函数
         function goBackToDashboard() {
              navigateToPage('dashboard');
              showToast('info', '已返回规则库');
          }
          
          function goBackToBuilder() {
              navigateToPage('builder');
              showToast('info', '已返回规则构建器，您可以继续编辑规则');
          }
         
         function saveAndActivateWithValidation() {
             // 验证必填字段
             const ruleName = document.getElementById('ruleName')?.value?.trim();
             if (!ruleName) {
                 showToast('warning', '请输入规则名称');
                 return;
             }
             
             // 验证是否有条件设置
             const hasConditions = document.querySelectorAll('.condition-row').length > 0;
             if (!hasConditions) {
                 showToast('warning', '请至少设置一个规则条件');
                 return;
             }
             
             if (confirm('确定要激活此规则吗？激活后规则将立即生效。')) {
                 // 调用原有的保存并激活函数
                 saveAndActivate();
                 
                 // 显示后续操作提示
                 setTimeout(() => {
                     if (confirm('规则已激活成功！是否返回规则库查看？')) {
                         goBackToDashboard();
                     }
                 }, 2000);
             }
         }
         
         function testRuleWithValidation() {
             // 验证必填字段
             const ruleName = document.getElementById('ruleName')?.value?.trim();
             if (!ruleName) {
                 showToast('warning', '请先输入规则名称再进行测试');
                 return;
             }
             
             // 验证是否有条件设置
             const hasConditions = document.querySelectorAll('.condition-row').length > 0;
             if (!hasConditions) {
                 showToast('warning', '请先设置规则条件再进行测试');
                 return;
             }
             
             console.log('测试规则');
             showToast('info', '正在准备测试环境...');
             
             // 模拟测试准备过程
             setTimeout(() => {
                 showToast('success', '测试环境准备完成，跳转到测试页面');
                 navigateToPage('test');
                 
                 // 在测试页面显示提示
                 setTimeout(() => {
                     showToast('info', '您可以在此页面输入测试数据验证规则逻辑');
                 }, 1000);
             }, 1500);
         }
        
        function clearForm() {
            if (confirm('确定要清空所有表单内容吗？此操作不可撤销。')) {
                // 清空基本信息
                const ruleName = document.getElementById('ruleName');
                const ruleDesc = document.getElementById('ruleDesc');
                if (ruleName) ruleName.value = '';
                if (ruleDesc) ruleDesc.value = '';
                
                // 清空标签
                const tagContainer = document.getElementById('tagContainer');
                if (tagContainer) {
                    const tags = tagContainer.querySelectorAll('.tag');
                    tags.forEach(tag => tag.remove());
                }
                
                // 重置条件（如果存在）
                const conditionsContainer = document.getElementById('conditionsContainer');
                if (conditionsContainer) {
                    conditionsContainer.innerHTML = `
                        <div class="condition-group" data-group-id="1">
                            <div class="condition-logic">
                                <span>当满足</span>
                                <div class="logic-switch">
                                    <span class="logic-option active" onclick="toggleLogic(this, 'AND')">所有条件 (AND)</span>
                                    <span class="logic-option" onclick="toggleLogic(this, 'OR')">任一条件 (OR)</span>
                                </div>
                                <span>时：</span>
                            </div>
                            <div class="condition-row">
                                <select class="form-select">
                                    <option>请选择字段</option>
                                    <optgroup label="患者信息">
                                        <option>患者年龄</option>
                                        <option>患者性别</option>
                                        <option>参保类型</option>
                                    </optgroup>
                                </select>
                                <select class="form-select">
                                    <option>等于</option>
                                    <option>不等于</option>
                                    <option>大于</option>
                                    <option>小于</option>
                                </select>
                                <input type="text" class="form-input" placeholder="请输入值">
                                <button class="remove-btn" onclick="removeCondition(this)">×</button>
                            </div>
                        </div>
                    `;
                }
                
                showToast('success', '表单已清空');
            }
        }

        // 全选功能
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');

            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });

            updateBatchOperations();
        }

        // 更新批量操作面板
        function updateBatchOperations() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const batchOperations = document.getElementById('batchOperations');
            const selectedCount = document.getElementById('selectedCount');

            if (checkedBoxes.length > 0) {
                batchOperations.style.display = 'flex';
                selectedCount.textContent = checkedBoxes.length;
            } else {
                batchOperations.style.display = 'none';
            }
        }

        // 监听行复选框变化
        document.addEventListener('change', function (event) {
            if (event.target.classList.contains('row-checkbox')) {
                updateBatchOperations();
            }
        });

        // 批量操作函数
        function batchEnable() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            console.log('批量启用:', Array.from(checkedBoxes).map(cb => cb.value));
            showToast('success', `已启用 ${checkedBoxes.length} 个规则`);
            updateBatchOperations();
        }

        function batchDisable() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            console.log('批量停用:', Array.from(checkedBoxes).map(cb => cb.value));
            showToast('success', `已停用 ${checkedBoxes.length} 个规则`);
            updateBatchOperations();
        }

        function batchDelete() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            if (confirm(`确定要删除选中的 ${checkedBoxes.length} 个规则吗？`)) {
                console.log('批量删除:', Array.from(checkedBoxes).map(cb => cb.value));
                showToast('success', `已删除 ${checkedBoxes.length} 个规则`);
                loadRuleList(); // 重新加载列表
                updateBatchOperations();
            }
        }

        // 分页相关函数
        function goToPage(page) {
            console.log('跳转到页面:', page);
            // 实现分页逻辑
        }

        function previousPage() {
            console.log('上一页');
            // 实现上一页逻辑
        }

        function nextPage() {
            console.log('下一页');
            // 实现下一页逻辑
        }

        // 重置筛选器
        function resetFilters() {
            document.querySelectorAll('.filter-select').forEach(select => {
                select.value = '';
            });

            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            loadRuleList();
            showToast('info', '筛选器已重置');
        }

        // 键盘快捷键支持
        document.addEventListener('keydown', function (event) {
            // Ctrl/Cmd + N: 新建规则
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                addRule();
            }

            // Ctrl/Cmd + S: 保存
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                saveAsDraft();
            }

            // Escape: 关闭模态框
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
        });

        // 重置自动保存定时器
        function resetAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveAsDraft();
                showToast('info', '已自动保存');
            }, 30000); // 30秒自动保存
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化规则类型选择：仅在没有用户选择时设置默认
            const ruleTypeInput = document.getElementById('ruleType');
            const hasUserSelection = !!(ruleTypeInput && ruleTypeInput.value);
            const defaultRuleType = hasUserSelection ? ruleTypeInput.value : 'condition';
            if (ruleTypeInput && !hasUserSelection) {
                ruleTypeInput.value = defaultRuleType;
            }
            // 如果当前页面是构建器，才应用默认切换，避免覆盖从模态框带入的选择
            const builderPage = document.getElementById('builder');
            if (builderPage && builderPage.classList.contains('active')) {
                switchRuleType(defaultRuleType);
            }
        });

        // 监听表单变化以触发自动保存
        document.addEventListener('input', function(event) {
            if (event.target.matches('input, textarea, select')) {
                resetAutoSave();
            }
        });

        // 页面可见性变化处理
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                // 页面隐藏时保存数据
                saveAsDraft();
            } else {
                // 页面显示时刷新数据
                loadInitialData();
            }
        });

        // 错误处理
        window.addEventListener('error', function (event) {
            console.error('页面错误:', event.error);
            showToast('error', '发生了一个错误，请刷新页面重试');
        });

        // 网络状态监听
        window.addEventListener('online', function () {
            showToast('success', '网络连接已恢复');
        });

        window.addEventListener('offline', function () {
            showToast('warning', '网络连接已断开');
        });

        // 页面卸载前保存
        window.addEventListener('beforeunload', function (event) {
            // 检查是否有未保存的更改
            const hasUnsavedChanges = checkUnsavedChanges();
            if (hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = '您有未保存的更改，确定要离开吗？';
                return event.returnValue;
            }
        });

        // 初始化规则构建器
        function initRuleBuilder() {
            // 设置默认规则类型为条件规则
            const defaultRuleType = 'condition';
            
            // 设置隐藏字段的默认值
            const ruleTypeInput = document.getElementById('ruleType');
            if (ruleTypeInput) {
                ruleTypeInput.value = defaultRuleType;
            }
            
            // 设置默认选中状态
            const typeOptions = document.querySelectorAll('.rule-type-option');
            typeOptions.forEach(opt => {
                if (opt.dataset.type === defaultRuleType) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            // 显示默认的规则配置区域
            switchRuleType(defaultRuleType);
        }
        
        // 检查未保存的更改
        function checkUnsavedChanges() {
            // 实现检查逻辑
            return false;
        }

        // 导出全局函数供HTML调用
        window.showPage = showPage;
        window.addRule = addRule;
        window.editRule = editRule;
        window.copyRule = copyRule;
        window.deleteRule = deleteRule;
        window.toggleRuleStatus = toggleRuleStatus;
        window.exportRules = exportRules;
        window.importRules = importRules;
        window.addWorkflowNode = addWorkflowNode;
        window.saveWorkflow = saveWorkflow;
        window.deployWorkflow = deployWorkflow;
        window.viewPatientRecord = viewPatientRecord;
        window.submitAudit = submitAudit;
        window.saveAsDraft = saveAsDraft;
        window.executeTest = executeTest;
        window.clearTestData = clearTestData;
        window.generateReport = generateReport;
        window.exportExcel = exportExcel;
        window.selectRuleType = selectRuleType;
        window.createRule = createRule;
        window.loadTemplate = loadTemplate;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.toggleSelectAll = toggleSelectAll;
        window.batchEnable = batchEnable;
        window.batchDisable = batchDisable;
        window.batchDelete = batchDelete;
        window.goToPage = goToPage;
        window.previousPage = previousPage;
        window.nextPage = nextPage;
        window.resetFilters = resetFilters;
        window.showToast = showToast;
        window.handleTagInput = handleTagInput;
        window.toggleLogic = toggleLogic;
        window.switchRuleType = switchRuleType;
        window.selectRuleType = selectRuleType;
        window.selectNewRuleType = selectNewRuleType;
        window.startCreateRule = startCreateRule;
        window.navigateToPage = navigateToPage;
        window.testRule = testRule;
        window.viewRule = viewRule;
        window.addCondition = addCondition;
        window.addDecisionRow = addDecisionRow;
    </script>

</body>

</html>